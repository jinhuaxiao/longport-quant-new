# Redis队列交易系统 - 信号处理流程详解

## 📊 系统架构

```
┌──────────────────────────────────────────────────────────────┐
│              Redis队列交易系统工作流程                         │
└──────────────────────────────────────────────────────────────┘

第1步：信号生成 (Signal Generator)
┌─────────────────────────────────────────────────────────────┐
│  📡 Signal Generator                                        │
│  • 每60秒扫描一次市场（可配置）                               │
│  • 分析32个标的（港股+美股+A股）                              │
│  • 对每个标的计算技术指标：                                   │
│    - RSI得分 (0-30分)                                       │
│    - 布林带得分 (0-25分)                                     │
│    - MACD得分 (0-20分)                                      │
│    - 成交量得分 (0-15分)                                     │
│    - 趋势得分 (0-10分)                                       │
│  • 综合评分 >= 30分 → 生成信号                               │
│  • 综合评分 < 30分 → 不生成信号                              │
└─────────────────────────────────────────────────────────────┘
                         ↓
            📤 发布信号到Redis队列
                         ↓

第2步：Redis优先级队列 (Priority Queue)
┌─────────────────────────────────────────────────────────────┐
│  🗄️  Redis ZSET (有序集合)                                  │
│                                                              │
│  队列名称: trading:signals                                   │
│  数据结构: Sorted Set (按优先级排序)                          │
│                                                              │
│  ┌────────────────────────────────────────────────┐         │
│  │ 优先级   标的        类型        评分         │         │
│  ├────────────────────────────────────────────────┤         │
│  │   65    9992.HK    STRONG_BUY   65           │ ← 最高    │
│  │   60    AAPL.US    STRONG_BUY   60           │         │
│  │   57    1398.HK    BUY          57           │         │
│  │   48    GOOGL.US   BUY          48           │         │
│  │   40    3690.HK    WEAK_BUY     40           │         │
│  │   35    0700.HK    WEAK_BUY     35           │ ← 最低    │
│  └────────────────────────────────────────────────┘         │
│                                                              │
│  • 高分信号优先处理（STRONG_BUY > BUY > WEAK_BUY）          │
│  • 自动持久化（Redis AOF）                                   │
│  • 原子操作（避免竞争条件）                                  │
│  • 支持重试机制（失败信号自动降低优先级重新入队）            │
└─────────────────────────────────────────────────────────────┘
                         ↓
              📥 Order Executor消费信号
                         ↓

第3步：订单执行 (Order Executor)
┌─────────────────────────────────────────────────────────────┐
│  ⚙️  Order Executor (可并发运行多个实例)                    │
│                                                              │
│  消费流程：                                                   │
│  1️⃣ ZPOPMIN 从队列取最高优先级信号                           │
│  2️⃣ 移动到 processing 队列（防止丢失）                       │
│  3️⃣ 执行风控检查：                                           │
│     ✓ 获取账户信息（余额、持仓）                              │
│     ✓ 检查可用资金                                           │
│     ✓ 计算动态预算（基于评分）                               │
│     ✓ 检查持仓限制                                           │
│  4️⃣ 计算订单参数：                                           │
│     • 数量 = f(预算, 价格, 手数)                             │
│     • 价格 = 智能下单价（买卖盘价格优化）                     │
│  5️⃣ 提交订单到LongPort API                                  │
│  6️⃣ 记录止损止盈到数据库                                     │
│  7️⃣ 发送Slack通知                                           │
│  8️⃣ 标记信号完成，从 processing 队列移除                     │
│                                                              │
│  失败处理：                                                   │
│  • 失败 → 标记失败 → 降低优先级 → 重新入队                   │
│  • 最多重试3次                                               │
│  • 3次失败后 → 移到 failed 队列                              │
└─────────────────────────────────────────────────────────────┘
                         ↓
              📊 LongPort API
                         ↓
              ✅ 订单已提交
```

## 🔄 处理速率

### 单个Executor
- **处理速率**: ~1-2信号/秒
- **限制因素**: API调用延迟、账户查询、行情查询

### 并发Executor (推荐)
```bash
# 启动3个executor实例
bash scripts/start_trading_system.sh 3
```

- **处理速率**: ~3-6信号/秒
- **优势**:
  - 高优先级信号立即处理
  - 队列积压快速消化
  - 故障自动恢复

## 📊 动态预算分配

根据信号评分动态分配资金：

| 评分范围 | 信号类型 | 预算比例 | 示例（净资产$50,000） |
|---------|---------|---------|---------------------|
| 60-100  | STRONG_BUY | 20-30% | $10,000 - $15,000 |
| 45-59   | BUY        | 10-20% | $5,000 - $10,000  |
| 30-44   | WEAK_BUY   | 5-10%  | $2,500 - $5,000   |
| < 30    | 无信号     | 0%     | 不交易              |

## 🔍 队列状态监控

### 查看队列实时状态
```bash
python3 scripts/queue_monitor.py
```

输出示例：
```
======================================================================
📊 队列状态
======================================================================
  📥 待处理队列: 32 个信号
  ⚙️  处理中队列: 2 个信号   ← executor正在处理
  ❌ 失败队列:   0 个信号
  📈 处理速率:   1.50 信号/秒
======================================================================

📋 待处理信号 (前10个):
----------------------------------------------------------------------
优先级      标的           类型           评分     排队时间
----------------------------------------------------------------------
65       9992.HK      STRONG_BUY   65     5秒前    ← 最先处理
60       AAPL.US      STRONG_BUY   60     8秒前
57       1398.HK      BUY          57     10秒前
48       GOOGL.US     BUY          48     15秒前
40       3690.HK      WEAK_BUY     40     20秒前
```

### 使用Redis CLI直接查看
```bash
# 查看队列长度
redis-cli ZCARD trading:signals

# 查看所有信号（带优先级）
redis-cli ZRANGE trading:signals 0 -1 WITHSCORES

# 查看最高优先级的5个信号
redis-cli ZRANGE trading:signals 0 4 WITHSCORES
```

## ⚡ 信号处理示例

### 信号生成日志
```log
📊 分析 9992.HK (泡泡玛特)
  实时行情: 价格=$291.00, 成交量=35,457,643

  信号评分:
    RSI得分: 25/30 (超卖(28.5))
    布林带得分: 25/25 (触及下轨($289.50))
    MACD得分: 20/20 (金叉)
    成交量得分: 10/15 (放量(1.8x))
    趋势得分: 5/10 (中性)

  📈 综合评分: 85/100

  ✅ 决策: 生成买入信号
     信号类型: STRONG_BUY
     强度: 0.85
     原因: RSI超卖(28.5), 触及布林带下轨, MACD金叉, 成交量放大(1.8x)

  ✅ 信号已发送到队列: STRONG_BUY, 评分=85, 优先级=85
```

### 订单执行日志
```log
======================================================================
📥 收到信号: 9992.HK, 类型=STRONG_BUY, 评分=85
======================================================================
🔍 开始处理 9992.HK 的 STRONG_BUY 信号

  💰 HKD 可用资金: $50,000.00
  📊 动态预算计算: 评分=85, 预算比例=26.25%, 金额=$13,125.00
  📏 手数: 100股/手
  🧮 购买数量: 4手 = 400股
  💵 所需资金: $116,400.00

  ✅ 开仓订单已提交: 116303991698937856
     标的: 9992.HK
     类型: STRONG_BUY
     评分: 85/100
     数量: 400股 (4手 × 100股/手)
     下单价: $291.00
     总额: $116,400.00
     止损位: $275.00
     止盈位: $320.00
```

## 🛡️ 重试机制

### 失败场景示例

**第1次尝试 (优先级=85)**
```
❌ 执行订单失败: 网络超时
⚠️ 信号处理失败，将重试 (1/3): 9992.HK
📤 重新入队，优先级降至 75
```

**第2次尝试 (优先级=75)**
```
❌ 执行订单失败: 资金不足
⚠️ 信号处理失败，将重试 (2/3): 9992.HK
📤 重新入队，优先级降至 65
```

**第3次尝试 (优先级=65)**
```
✅ 订单执行成功
📌 标记信号完成
```

**或者3次都失败:**
```
❌ 信号处理失败（已达最大重试次数）
📍 移动到失败队列: trading:signals:failed
```

## 🚀 启动系统

### 方式1：一键启动（推荐）
```bash
# 启动1个信号生成器 + 1个订单执行器
bash scripts/start_trading_system.sh

# 启动1个信号生成器 + 3个订单执行器（并发处理）
bash scripts/start_trading_system.sh 3
```

### 方式2：手动启动（调试用）
```bash
# 终端1：信号生成器
python3 scripts/signal_generator.py

# 终端2-4：订单执行器（3个实例）
python3 scripts/order_executor.py &
python3 scripts/order_executor.py &
python3 scripts/order_executor.py &

# 终端5：队列监控
python3 scripts/queue_monitor.py
```

## 🛑 停止系统
```bash
bash scripts/stop_trading_system.sh
```

## 📊 性能指标

| 指标 | 单Executor | 3个Executor |
|-----|-----------|------------|
| 处理速率 | 1-2/秒 | 3-6/秒 |
| 队列积压 | 可能 | 不太可能 |
| 延迟 | 30-60秒 | 5-15秒 |
| 高优先级响应 | 慢 | 快 |

## ⚠️ 注意事项

1. **Redis必须运行**
   ```bash
   redis-cli ping  # 应返回 PONG
   ```

2. **队列积压处理**
   - 如果待处理队列 > 50，建议启动更多executor实例
   - 高优先级信号（STRONG_BUY）应在15秒内处理

3. **失败队列监控**
   - 定期检查失败队列：`redis-cli ZCARD trading:signals:failed`
   - 失败信号需要人工审查原因

4. **API限流**
   - LongPort API有调用频率限制
   - 过多并发executor可能触发限流
   - 建议不超过5个executor实例

---

**创建日期**: 2025-10-16
**状态**: ✅ 已验证
**相关文档**: QUICK_START_QUEUE_SYSTEM.md, FIX_CLIENT_INITIALIZATION.md
