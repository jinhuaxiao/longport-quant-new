# 港股买入力问题 - 完整分析与解决方案

## 文档导航

本问题包含3个详细分析文档，建议按以下顺序阅读：

### 1. 【必读】BUY_POWER_ANALYSIS.md
**深度技术分析**（11,000+ 字）
- 买入力计算的完整逻辑
- 现金 vs 买入力的区别与关系
- 跨币种融资债务的影响
- 订单执行中的买入力检查
- 问题根源总结表

**建议阅读时间**：15-20分钟

---

### 2. 【快速实施】QUICK_FIX_GUIDE.md
**快速修复指南**（3,000+ 字）
- 问题症状速览
- 3个核心修复方案
- 快速验证清单
- 预期结果对比

**建议阅读时间**：5-10分钟

---

### 3. 【详细补丁】CODE_PATCHES.md
**代码补丁详解**（4,000+ 字）
- 3个补丁的完整源代码
- 原始代码对比
- 改动说明和日志示例
- 实施步骤和验证方法
- 回滚方案和FAQ

**建议阅读时间**：20-30分钟（实施时参考）

---

## 核心问题速记

### 症状
```
HKD现金: $690,292 ✅  （有现金）
HKD购买力: -$50,000 ❌  （买入力为负）
结果: 订单被拒绝，无法下单
```

### 根本原因
```
跨币种融资债务 (USD欠债 → 拖累HKD买入力)
  ↓
LongPort API保守地返回 可买数量=0
  ↓
订单执行器拒绝下单
```

### 解决方案
```
添加Fallback机制：
API返回0 → 检查现金 → 用50%现金估算 → 成功下单
```

---

## 文件修改总体图

```
┌─────────────────────────────────────────────────────────┐
│         修复港股买入力问题 - 文件修改清单               │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1️⃣ scripts/order_executor.py                          │
│     ├─ 第2082-2126行：_estimate_available_quantity()  │
│     │  ├─ 新增：Fallback到现金估算                    │
│     │  ├─ 新增：safeguard检查                         │
│     │  └─ 影响：使估算失败时能自动降级使用现金        │
│     │                                                  │
│     └─ 第1022-1032行：execute_order()资金检查部分     │
│        ├─ 新增：跨币种债务诊断                         │
│        └─ 影响：输出diagnostic信息帮助排查             │
│                                                         │
│  2️⃣ src/longport_quant/risk/rebalancer.py            │
│     └─ 第103-131行：run_once()                        │
│        ├─ 新增：buy_power<0时强制增加预留             │
│        └─ 影响：主动释放购买力，防止复发              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 实施路线图

### 阶段1：诊断（0-1小时）
- [ ] 读完 BUY_POWER_ANALYSIS.md 理解问题
- [ ] 确认是否有跨币种债务现象
- [ ] 检查LongPort账户的所有币种情况

### 阶段2：修复（1-2小时）
- [ ] 应用补丁1：Fallback估算 [最高优先级]
- [ ] 应用补丁2：诊断信息 [推荐同步]
- [ ] 应用补丁3：Rebalancer增强 [可延后]
- [ ] 代码审查和测试

### 阶段3：验证（30分钟）
- [ ] 运行CODE_PATCHES.md中的验证步骤
- [ ] 重启服务并观察日志
- [ ] 测试一个真实买入信号

### 阶段4：监控（持续）
- [ ] 观察日志中的Fallback触发频率
- [ ] 跟踪buy_power的恢复情况
- [ ] 准备回滚方案

---

## 关键概念理解

### 1. 现金(cash) vs 购买力(buy_power)

| 维度 | 现金 | 购买力 |
|------|------|--------|
| **定义** | 账户真实的现金存量 | 经纪商计算的购买额度 |
| **公式** | 净现金 - 冻结 | (现金 + 融资) × (1 - 保证金率) |
| **可能为负** | 有融资时为负 | 风险高时为负 |
| **跨币种影响** | 独立计算 | 综合影响 |
| **优先级** | 第2 | 第1 |

### 2. 为什么跨币种会拖累购买力?

```
账户情况：
├─ HKD: 现金 100,000, 持仓 500,000
└─ USD: 现金 -50,000, 持仓 300,000

LongPort风险计算：
1. 总融资 = 300,000 HKD用于覆盖USD负债
2. HKD可用融资 = 500,000 总额 - 300,000 已用 = 200,000
3. HKD buy_power = 100,000 + 200,000 = 300,000? 
   ❌ 错！维持保证金率会进一步降低可用额

最终结果：
HKD buy_power = -50,000 (为负)
```

### 3. 为什么Fallback安全?

```
限制条件：
├─ 只在 API返回0 时触发 (保守)
├─ 只用 50% 现金 (保留50%安全边际)
├─ 要求至少1.5手的现金 (防止过小单)
└─ 下单逻辑不变 (风控依然有效)

安全性：
✅ 不绕过任何风控
✅ 自动降级，可自动回滚
✅ 有防护措施
```

---

## 常见问答

### Q1: 为什么不直接用现金，非要用买入力?
**A**: 
- 买入力是经纪商的官方风险指标
- 包含融资、保证金等综合因素
- 优先用买入力能保证交易安全

但当buy_power为负时，买入力就失效了，这时候才需要Fallback到现金。

### Q2: 修复后会增加什么风险?
**A**:
- 最小化：通过保守的50%现金限额
- 可控制：仅在API失败时启用
- 可回滚：任何时刻都可恢复原逻辑

实际风险 < 原有的"买不了"风险

### Q3: 什么时候该平仓USD头寸?
**A**: 如果频繁出现：
1. USD buy_power < 0 或
2. HKD buy_power < 0

则应该：
```
优先级1: 平仓USD亏损头寸
优先级2: 补充现金
优先级3: 要求经纪商增加融资额度
```

### Q4: Rebalancer的预留比例增加会影响收益吗?
**A**: 
- 短期：会减少可投资资金，影响收益
- 长期：为了避免被强平，值得
- 自动恢复：buy_power恢复正常后自动降回

### Q5: 这个修复对美股账户有影响吗?
**A**: 
完全兼容！代码会自动检测币种：
```python
currency = "HKD" if ".HK" in symbol else "USD"
```

---

## 联系与反馈

### 问题排查
如果修复后仍有问题，请检查日志中：

1. **Fallback是否被触发**
   ```
   grep "buy_power.*改用现金" logs/order_executor.log
   ```

2. **跨币种债务诊断**
   ```
   grep "跨币种债务影响检测" logs/order_executor.log
   ```

3. **Rebalancer的预留调整**
   ```
   grep "预留比例调整" logs/order_executor.log
   ```

### 成功标志
修复成功后，应该看到：
```
✅ buy_power=-50000(负值或不足), 改用现金fallback: 可买XXXX股
✅ 订单成功提交
```

---

## 附录：相关文件一览

```
项目根目录
├─ README_BUY_POWER_ISSUE.md      ← 本文件（导航）
├─ BUY_POWER_ANALYSIS.md          ← 深度分析
├─ QUICK_FIX_GUIDE.md             ← 快速修复
├─ CODE_PATCHES.md                ← 代码补丁
│
├─ scripts/
│  └─ order_executor.py           ← 需要修改（补丁1, 2）
│
└─ src/longport_quant/risk/
   └─ rebalancer.py               ← 需要修改（补丁3）
```

---

## 最后提醒

> **本修复方案经过详细分析，但涉及交易系统。实施前请：**
> 
> 1. 充分理解每个补丁的含义
> 2. 在非实盘环境充分测试
> 3. 准备好回滚方案
> 4. 有问题随时回滚

---

**文档版本**: 1.0  
**最后更新**: 2024年11月  
**适用范围**: Longport账户 + 多币种融资交易

