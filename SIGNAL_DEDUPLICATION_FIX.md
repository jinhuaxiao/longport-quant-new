# ä¿¡å·é‡å¤æäº¤ä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2025-11-13
**é—®é¢˜**: CRWV.US ç­‰æ ‡çš„çš„å–å‡ºè®¢å•è¢«é‡å¤æäº¤å¤šæ¬¡
**ä¿®å¤æäº¤**: commit 83ba5df

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Š CRWV.US çš„ URGENT_SELL ä¿¡å·è¢«é‡å¤æäº¤ï¼Œæ—¥å¿—æ˜¾ç¤ºï¼š

```
2025-11-13 11:11:48.876 | INFO | #1 CRWV.US - URGENT_SELL (95åˆ†)
2025-11-13 11:11:48.876 | INFO | #2 CRWV.US - URGENT_SELL (95åˆ†)
2025-11-13 11:11:48.876 | INFO | #3 CRWV.US - URGENT_SELL (95åˆ†)
```

åŒä¸€ä¸ªæ ‡çš„çš„ç›¸åŒç±»å‹ä¿¡å·åœ¨é˜Ÿåˆ—ä¸­å‡ºç°3æ¬¡ï¼Œå¯¼è‡´ï¼š
- è®¢å•è¢«é‡å¤æäº¤
- ä¸å¿…è¦çš„é‡è¯•å’ŒAPIè°ƒç”¨
- æ—¥å¿—åˆ·å±
- å¯èƒ½çš„é£é™©æ§åˆ¶é—®é¢˜

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. åå°ä»»åŠ¡æœºåˆ¶

ç³»ç»Ÿæœ‰ä¸€ä¸ªåå°ä»»åŠ¡ `_rotation_checker_loop()`ï¼ˆä½äº `signal_generator.py:4878`ï¼‰ï¼š
- æ¯30ç§’è¿è¡Œä¸€æ¬¡
- æ£€æŸ¥æ‰€æœ‰æŒä»“çš„æŠ€æœ¯é¢æƒ…å†µ
- ç”Ÿæˆç´§æ€¥å–å‡ºä¿¡å·ï¼ˆURGENT_SELLï¼‰
- ç”Ÿæˆå®æ—¶è½®æ¢ä¿¡å·ï¼ˆROTATION_SELLï¼‰

### 2. ä¿¡å·ç”Ÿå‘½å‘¨æœŸ

```
åå°ä»»åŠ¡(T=0) â†’ æ£€æµ‹CRWV.USéœ€è¦ç´§æ€¥å–å‡º â†’ å‘å¸ƒä¿¡å·åˆ°é˜Ÿåˆ—
              â†“
è®¢å•æ‰§è¡Œå™¨ â†’ å°è¯•æ‰§è¡Œè®¢å• â†’ å¤±è´¥ï¼ˆå¸‚åœºä¼‘å¸‚/è®¢å•è¢«æ‹’ç»ï¼‰
              â†“
            æ ‡è®°å¤±è´¥ï¼Œé‡æ–°å…¥é˜Ÿï¼ˆretry_after = T+300ç§’ï¼‰
              â†“
åå°ä»»åŠ¡(T=30) â†’ å†æ¬¡æ£€æµ‹CRWV.USï¼ˆä»ç„¶éœ€è¦ç´§æ€¥å–å‡ºï¼‰â†’ å‘å¸ƒç¬¬2ä¸ªä¿¡å·
              â†“
åå°ä»»åŠ¡(T=60) â†’ å†æ¬¡æ£€æµ‹CRWV.US â†’ å‘å¸ƒç¬¬3ä¸ªä¿¡å·
              â†“
ç»“æœï¼šé˜Ÿåˆ—ä¸­æœ‰3ä¸ªç›¸åŒçš„ä¿¡å·
```

### 3. ç¼ºå¤±çš„å»é‡æœºåˆ¶

**é—®é¢˜ä½ç½®1**: `signal_generator.py:4948` (ç´§æ€¥å–å‡º)
```python
# âŒ æ—§ä»£ç ï¼šç›´æ¥å‘å¸ƒï¼Œæ— å»é‡æ£€æŸ¥
for signal in urgent_signals:
    await self.signal_queue.publish_signal(signal)
```

**é—®é¢˜ä½ç½®2**: `signal_generator.py:4934` (å®æ—¶è½®æ¢)
```python
# âŒ æ—§ä»£ç ï¼šç›´æ¥å‘å¸ƒï¼Œæ— å»é‡æ£€æŸ¥
for signal in rotation_signals:
    await self.signal_queue.publish_signal(signal)
```

**é—®é¢˜ä½ç½®3**: `signal_generator.py:1694` (æ”¶ç›˜è½®æ¢)
```python
# âŒ æ—§ä»£ç ï¼šç›´æ¥å‘å¸ƒï¼Œæ— å»é‡æ£€æŸ¥
for rotation_signal in rotation_signals:
    await self.signal_queue.publish_signal(rotation_signal)
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å‘ç°å·²æœ‰å·¥å…·

`SignalQueue` ç±»ä¸­å·²ç»æœ‰ `has_pending_signal()` æ–¹æ³•ï¼ˆ`signal_queue.py:681`ï¼‰ï¼š

```python
async def has_pending_signal(self, symbol: str, signal_type: str = None) -> bool:
    """
    æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥æ ‡çš„çš„å¾…å¤„ç†ä¿¡å·ï¼ˆæ’é™¤å»¶è¿Ÿä¿¡å·ï¼‰

    Args:
        symbol: æ ‡çš„ä»£ç 
        signal_type: ä¿¡å·ç±»å‹ï¼ˆå¯é€‰ï¼‰ï¼Œå¦‚'BUY', 'SELL'

    Returns:
        bool: æ˜¯å¦å­˜åœ¨çœŸæ­£å¾…å¤„ç†çš„ä¿¡å·
    """
```

**ç‰¹æ€§**ï¼š
- æ£€æŸ¥ä¸»é˜Ÿåˆ—å’Œå¤„ç†ä¸­é˜Ÿåˆ—
- **æ’é™¤å»¶è¿Ÿä¿¡å·**ï¼ˆretry_afteræœªåˆ°çš„ä¿¡å·ä¸é˜»æ­¢æ–°ä¿¡å·ï¼‰
- æ”¯æŒæŒ‰ä¿¡å·ç±»å‹è¿‡æ»¤

### 2. æ·»åŠ å»é‡æ£€æŸ¥

**ä¿®æ”¹1: ç´§æ€¥å–å‡ºä¿¡å·**ï¼ˆ`signal_generator.py:4944-4983`ï¼‰

```python
if urgent_signals:
    logger.info(f"ğŸš¨ åå°æ£€æŸ¥è§¦å‘ç´§æ€¥å–å‡º: ç”Ÿæˆ {len(urgent_signals)} ä¸ªå–å‡ºä¿¡å·")
    # å‘å¸ƒåˆ°ä¿¡å·é˜Ÿåˆ—ï¼ˆå¸¦å»é‡æ£€æŸ¥ï¼‰
    published_count = 0
    for signal in urgent_signals:
        symbol = signal.get('symbol')
        signal_type = signal.get('type')

        # ğŸ”¥ å»é‡æ£€æŸ¥ï¼šé¿å…é‡å¤æäº¤ç›¸åŒçš„ç´§æ€¥å–å‡ºä¿¡å·
        if await self.signal_queue.has_pending_signal(symbol, signal_type):
            logger.debug(
                f"  â­ï¸  {symbol}: é˜Ÿåˆ—ä¸­å·²æœ‰{signal_type}ä¿¡å·ï¼Œè·³è¿‡"
            )
            continue

        await self.signal_queue.publish_signal(signal)
        published_count += 1

    if published_count > 0:
        logger.info(f"  âœ… å·²å‘å¸ƒ {published_count}/{len(urgent_signals)} ä¸ªæ–°ä¿¡å·")
    if published_count < len(urgent_signals):
        logger.debug(
            f"  â­ï¸  è·³è¿‡ {len(urgent_signals) - published_count} ä¸ªé‡å¤ä¿¡å·"
        )
```

**ä¿®æ”¹2: å®æ—¶è½®æ¢ä¿¡å·**ï¼ˆ`signal_generator.py:4930-4953`ï¼‰

```python
if rotation_signals:
    logger.info(f"ğŸ”” åå°æ£€æŸ¥è§¦å‘å®æ—¶æŒªä»“: ç”Ÿæˆ {len(rotation_signals)} ä¸ªå–å‡ºä¿¡å·")
    # å‘å¸ƒåˆ°ä¿¡å·é˜Ÿåˆ—ï¼ˆå¸¦å»é‡æ£€æŸ¥ï¼‰
    published_count = 0
    for signal in rotation_signals:
        symbol = signal.get('symbol')
        signal_type = signal.get('type')

        # ğŸ”¥ å»é‡æ£€æŸ¥ï¼šé¿å…é‡å¤æäº¤ç›¸åŒçš„è½®æ¢ä¿¡å·
        if await self.signal_queue.has_pending_signal(symbol, signal_type):
            logger.debug(
                f"  â­ï¸  {symbol}: é˜Ÿåˆ—ä¸­å·²æœ‰{signal_type}ä¿¡å·ï¼Œè·³è¿‡"
            )
            continue

        await self.signal_queue.publish_signal(signal)
        published_count += 1

    if published_count > 0:
        logger.info(f"  âœ… å·²å‘å¸ƒ {published_count}/{len(rotation_signals)} ä¸ªæ–°ä¿¡å·")
    if published_count < len(rotation_signals):
        logger.debug(
            f"  â­ï¸  è·³è¿‡ {len(rotation_signals) - published_count} ä¸ªé‡å¤ä¿¡å·"
        )
```

**ä¿®æ”¹3: æ”¶ç›˜è½®æ¢ä¿¡å·**ï¼ˆ`signal_generator.py:1693-1712`ï¼‰

```python
# å‘é€è½®æ¢ä¿¡å·åˆ°é˜Ÿåˆ—ï¼ˆå¸¦å»é‡æ£€æŸ¥ï¼‰
for rotation_signal in rotation_signals:
    symbol = rotation_signal.get('symbol')
    signal_type = rotation_signal.get('type')

    # ğŸ”¥ å»é‡æ£€æŸ¥ï¼šé¿å…é‡å¤æäº¤ç›¸åŒçš„æ”¶ç›˜è½®æ¢ä¿¡å·
    if await self.signal_queue.has_pending_signal(symbol, signal_type):
        logger.debug(
            f"  â­ï¸  {symbol}: é˜Ÿåˆ—ä¸­å·²æœ‰{signal_type}ä¿¡å·ï¼Œè·³è¿‡"
        )
        continue

    success = await self.signal_queue.publish_signal(rotation_signal)
    if success:
        logger.success(
            f"  âœ… è½®æ¢ä¿¡å·å·²å‘é€: {rotation_signal['symbol']}, "
            f"è¯„åˆ†={rotation_signal['score']}"
        )
    else:
        logger.error(f"  âŒ è½®æ¢ä¿¡å·å‘é€å¤±è´¥: {rotation_signal['symbol']}")
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

åˆ›å»ºäº† `test_signal_deduplication.py` æµ‹è¯•è„šæœ¬ï¼š

```bash
$ python3 test_signal_deduplication.py

======================================================================
ğŸ§ª æµ‹è¯•ä¿¡å·å»é‡é€»è¾‘
======================================================================

1ï¸âƒ£ æ¸…ç©ºæµ‹è¯•é˜Ÿåˆ—...
   âœ… é˜Ÿåˆ—å·²æ¸…ç©º

2ï¸âƒ£ å‘å¸ƒç¬¬ä¸€ä¸ª CRWV.US URGENT_SELL ä¿¡å·...
   âœ… ä¿¡å·å·²å‘å¸ƒ

3ï¸âƒ£ æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦å·²å­˜åœ¨ CRWV.US URGENT_SELL...
   ç»“æœ: True
   âœ… å»é‡æ£€æŸ¥æ­£å¸¸

4ï¸âƒ£ æ¨¡æ‹Ÿåå°ä»»åŠ¡å°è¯•å‘å¸ƒé‡å¤ä¿¡å·...
   â­ï¸  é˜Ÿåˆ—ä¸­å·²æœ‰ CRWV.US URGENT_SELL ä¿¡å·ï¼Œè·³è¿‡
   âœ… é‡å¤ä¿¡å·è¢«æ­£ç¡®è·³è¿‡

5ï¸âƒ£ æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦...
   é˜Ÿåˆ—é•¿åº¦: 1
   âœ… é˜Ÿåˆ—ä¸­åªæœ‰1ä¸ªä¿¡å·ï¼ˆå»é‡æˆåŠŸï¼‰

6ï¸âƒ£ æµ‹è¯•ä¸åŒä¿¡å·ç±»å‹...
   é˜Ÿåˆ—é•¿åº¦: 2
   âœ… ä¸åŒç±»å‹çš„ä¿¡å·å¯ä»¥å…±å­˜

7ï¸âƒ£ æµ‹è¯•ä¸åŒæ ‡çš„...
   é˜Ÿåˆ—é•¿åº¦: 3
   âœ… ä¸åŒæ ‡çš„çš„ä¿¡å·å¯ä»¥å…±å­˜

======================================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
======================================================================
```

### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|------|---------|---------|
| å‘å¸ƒç¬¬ä¸€ä¸ªä¿¡å· | æˆåŠŸå‘å¸ƒ | âœ… é€šè¿‡ |
| æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ | è¿”å› True | âœ… é€šè¿‡ |
| å°è¯•å‘å¸ƒé‡å¤ä¿¡å· | è¢«è·³è¿‡ | âœ… é€šè¿‡ |
| æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦ | åªæœ‰1ä¸ªä¿¡å· | âœ… é€šè¿‡ |
| å‘å¸ƒä¸åŒç±»å‹ä¿¡å· | å¯ä»¥å…±å­˜ | âœ… é€šè¿‡ |
| å‘å¸ƒä¸åŒæ ‡çš„ä¿¡å· | å¯ä»¥å…±å­˜ | âœ… é€šè¿‡ |

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
T=0s:  åå°ä»»åŠ¡ â†’ å‘å¸ƒ CRWV.US URGENT_SELL #1
T=30s: åå°ä»»åŠ¡ â†’ å‘å¸ƒ CRWV.US URGENT_SELL #2  âŒ
T=60s: åå°ä»»åŠ¡ â†’ å‘å¸ƒ CRWV.US URGENT_SELL #3  âŒ

é˜Ÿåˆ—ä¸­æœ‰3ä¸ªç›¸åŒä¿¡å· â†’ é‡å¤æäº¤è®¢å• âŒ
```

### ä¿®å¤å

```
T=0s:  åå°ä»»åŠ¡ â†’ å‘å¸ƒ CRWV.US URGENT_SELL #1  âœ…
T=30s: åå°ä»»åŠ¡ â†’ æ£€æµ‹åˆ°å·²å­˜åœ¨ â†’ è·³è¿‡  âœ…
T=60s: åå°ä»»åŠ¡ â†’ æ£€æµ‹åˆ°å·²å­˜åœ¨ â†’ è·³è¿‡  âœ…

é˜Ÿåˆ—ä¸­åªæœ‰1ä¸ªä¿¡å· â†’ ä¸é‡å¤æäº¤ âœ…
```

### æ—¥å¿—å¯¹æ¯”

**ä¿®å¤å‰**:
```
2025-11-13 11:11:48.876 | INFO | ğŸš¨ åå°æ£€æŸ¥è§¦å‘ç´§æ€¥å–å‡º: ç”Ÿæˆ 1 ä¸ªå–å‡ºä¿¡å·
2025-11-13 11:12:18.876 | INFO | ğŸš¨ åå°æ£€æŸ¥è§¦å‘ç´§æ€¥å–å‡º: ç”Ÿæˆ 1 ä¸ªå–å‡ºä¿¡å·
2025-11-13 11:12:48.876 | INFO | ğŸš¨ åå°æ£€æŸ¥è§¦å‘ç´§æ€¥å–å‡º: ç”Ÿæˆ 1 ä¸ªå–å‡ºä¿¡å·
```

**ä¿®å¤å**:
```
2025-11-13 11:11:48.876 | INFO | ğŸš¨ åå°æ£€æŸ¥è§¦å‘ç´§æ€¥å–å‡º: ç”Ÿæˆ 1 ä¸ªå–å‡ºä¿¡å·
2025-11-13 11:11:48.876 | INFO |   âœ… å·²å‘å¸ƒ 1/1 ä¸ªæ–°ä¿¡å·
2025-11-13 11:12:18.876 | INFO | ğŸš¨ åå°æ£€æŸ¥è§¦å‘ç´§æ€¥å–å‡º: ç”Ÿæˆ 1 ä¸ªå–å‡ºä¿¡å·
2025-11-13 11:12:18.876 | DEBUG |   â­ï¸  CRWV.US: é˜Ÿåˆ—ä¸­å·²æœ‰URGENT_SELLä¿¡å·ï¼Œè·³è¿‡
2025-11-13 11:12:18.876 | DEBUG |   â­ï¸  è·³è¿‡ 1 ä¸ªé‡å¤ä¿¡å·
```

---

## ğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹

### 1. æ™ºèƒ½å»é‡
- âœ… åŸºäº `(symbol, signal_type)` ç»„åˆå»é‡
- âœ… å…è®¸åŒä¸€æ ‡çš„çš„ä¸åŒç±»å‹ä¿¡å·å…±å­˜ï¼ˆå¦‚ URGENT_SELL å’Œ ROTATION_SELLï¼‰
- âœ… å…è®¸ä¸åŒæ ‡çš„çš„ç›¸åŒç±»å‹ä¿¡å·å…±å­˜

### 2. å»¶è¿Ÿä¿¡å·å¤„ç†
- âœ… å»¶è¿Ÿä¿¡å·ï¼ˆ`retry_after`æœªåˆ°ï¼‰ä¸é˜»æ­¢æ–°ä¿¡å·ç”Ÿæˆ
- âœ… åªæœ‰çœŸæ­£å¾…å¤„ç†çš„ä¿¡å·æ‰å‚ä¸å»é‡æ£€æŸ¥

### 3. æ€§èƒ½ä¼˜åŒ–
- âœ… å‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨
- âœ… å‡å°‘Rediså†™å…¥æ“ä½œ
- âœ… å‡å°‘è®¢å•æ‰§è¡Œå™¨çš„å·¥ä½œè´Ÿè½½

### 4. æ—¥å¿—æ”¹è¿›
- âœ… æ¸…æ™°æ˜¾ç¤ºå‘å¸ƒäº†å¤šå°‘æ–°ä¿¡å·
- âœ… æ˜¾ç¤ºè·³è¿‡äº†å¤šå°‘é‡å¤ä¿¡å·
- âœ… ä¾¿äºè¯Šæ–­å’Œç›‘æ§

---

## ğŸ“ ç›¸å…³ä»£ç æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `scripts/signal_generator.py` - æ·»åŠ ä¿¡å·å‘å¸ƒå‰å»é‡æ£€æŸ¥
  - Line 1693-1712: æ”¶ç›˜è½®æ¢ä¿¡å·å»é‡
  - Line 4930-4953: å®æ—¶è½®æ¢ä¿¡å·å»é‡
  - Line 4944-4983: ç´§æ€¥å–å‡ºä¿¡å·å»é‡

### æ–°å¢çš„æ–‡ä»¶
- `test_signal_deduplication.py` - å»é‡é€»è¾‘æµ‹è¯•è„šæœ¬

### ä¾èµ–çš„ç°æœ‰ä»£ç 
- `src/longport_quant/messaging/signal_queue.py:681` - `has_pending_signal()` æ–¹æ³•

---

## ğŸ”® åç»­æ”¹è¿›å»ºè®®

### 1. æ‰©å±•åˆ°å…¶ä»–ä¿¡å·ç±»å‹
å½“å‰ä¿®å¤è¦†ç›–äº†ï¼š
- âœ… ç´§æ€¥å–å‡ºä¿¡å·ï¼ˆURGENT_SELLï¼‰
- âœ… å®æ—¶è½®æ¢ä¿¡å·ï¼ˆROTATION_SELLï¼‰
- âœ… æ”¶ç›˜è½®æ¢ä¿¡å·ï¼ˆTIMEZONE_ROTATION_SELLï¼‰

å…¶ä»–ä¿¡å·ç±»å‹ï¼ˆå¦‚æ™®é€šä¹°å…¥ä¿¡å·ï¼‰å·²ç»åœ¨ `_should_generate_signal()` ä¸­æœ‰å»é‡æ£€æŸ¥ã€‚

### 2. ç›‘æ§å’Œå‘Šè­¦
- å»ºè®®æ·»åŠ æŒ‡æ ‡ç»Ÿè®¡è·³è¿‡çš„é‡å¤ä¿¡å·æ•°é‡
- å¦‚æœé‡å¤ä¿¡å·è¿‡å¤šï¼Œå¯èƒ½è¯´æ˜é…ç½®æœ‰é—®é¢˜

### 3. é…ç½®é€‰é¡¹
- è€ƒè™‘æ·»åŠ é…ç½®é¡¹æ§åˆ¶æ˜¯å¦å¯ç”¨ä¸¥æ ¼å»é‡
- æŸäº›åœºæ™¯ä¸‹å¯èƒ½éœ€è¦å…è®¸é‡å¤ä¿¡å·ï¼ˆå¦‚åŠ ä»“ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¿¡å·é˜Ÿåˆ—è®¾è®¡æ–‡æ¡£](docs/SIGNAL_QUEUE_DESIGN.md)
- [æŒæœ‰è¯„åˆ†ä¿®å¤](HOLDING_SCORE_FIX.md) - commit 90d74d7
- [å­—å…¸å»é‡ä¿®å¤](DICT_DEDUPLICATION_FIX.md) - commit 99115d5

---

**ä¿®å¤æäº¤**: commit 83ba5df
**æµ‹è¯•é€šè¿‡**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
**ç”Ÿäº§éƒ¨ç½²**: å¾…éªŒè¯
