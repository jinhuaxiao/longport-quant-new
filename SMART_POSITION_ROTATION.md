# 智能持仓轮换系统

## 问题背景

当账户达到最大持仓数（10个）时，即使出现强烈的买入信号也无法执行，导致错过优质投资机会。

## 解决方案

我们实现了一个智能持仓轮换系统，该系统可以：

1. **自动评估现有持仓强度** - 通过多维度评分系统
2. **比较新信号与现有持仓** - 智能决策是否值得替换
3. **自动执行持仓轮换** - 卖出弱势持仓，为强信号腾出空间

## 核心功能

### 1. 持仓强度评估（100分制）

```python
评分维度：
- 盈亏状况 (30分)
  * 大幅盈利(>10%): 30分
  * 中等盈利(5-10%): 25分
  * 小幅盈利(2-5%): 20分
  * 微盈(0-2%): 15分
  * 小幅亏损(-3-0%): 10分
  * 中等亏损(-5--3%): 5分
  * 大幅亏损(<-5%): 0分

- 技术指标 (30分)
  * RSI状态
  * MACD趋势
  * 均线位置

- 持仓时间 (20分)
  * 长期持仓(>30天): 20分
  * 中期持仓(14-30天): 15分
  * 短期持仓(7-14天): 10分
  * 新持仓(3-7天): 5分
  * 刚买入(<3天): 0分

- 成交量 (10分)
  * 放量(>2x): 10分
  * 温和放量(1.5-2x): 7分
  * 正常(1-1.5x): 5分
  * 缩量(<1x): 2分

- 止损距离 (10分)
  * 远离止损(>10%): 10分
  * 安全距离(5-10%): 7分
  * 接近止损(3-5%): 5分
  * 危险区域(<3%): 2分
```

### 2. 智能决策逻辑

系统会自动比较新信号与最弱持仓的评分：

- **立即替换条件**：
  - 最弱持仓已触发止损（评分=0）
  - 弱势持仓（<30分）+ 强新信号（>60分）
  - 亏损持仓（<-2%）+ 中等新信号（>50分）
  - 评分差距显著（差值>20分）

### 3. 集成方式

系统已集成到 `advanced_technical_trading.py` 脚本中：

```python
# 在 _try_make_room 函数中
try:
    from smart_position_rotation import SmartPositionRotator
    rotator = SmartPositionRotator()

    rotation_success = await rotator.execute_position_rotation(
        new_signal, self.trade_client, self.quote_client
    )

    if rotation_success:
        logger.success("✅ 智能持仓轮换成功，已腾出空间")
        return True
except:
    # 使用传统备选方案
    pass
```

## 使用示例

### 1. 测试持仓评估

```bash
python3 scripts/smart_position_rotation.py
```

输出示例：
```
📊 评估所有持仓强度...
  NVDA.US: 20.0分 (盈亏-5.0%, 持仓0天)
  981.HK: 25.0分 (盈亏-4.4%, 持仓0天)
  1347.HK: 45.0分 (盈亏+5.5%, 持仓0天)

🎯 最弱持仓:
  NVDA.US: 20.0分 (建议替换)

📈 信号对比: 新信号97.0分 vs 最弱持仓20.0分
```

### 2. 实际交易中的应用

当运行 `advanced_technical_trading.py` 时，系统会自动：

1. 检测到满仓状态
2. 评估新信号强度
3. 找出最弱持仓
4. 执行智能轮换决策

示例日志：
```
💼 检测到满仓（10/10），尝试智能仓位管理
📊 评估仓位清理: 当前持仓数 10/10
🔄 智能仓位管理决策: 执行清理
   清理标的: NVDA.US
   原因: 弱势持仓(评分:20) vs 强信号(评分:85)
   持仓评分: 20/100, 盈亏: -5.00%
   新信号: 0700.HK
   新信号类型: STRONG_BUY, 评分: 85/100
✅ 轮换平仓订单已提交
```

## 风险控制

1. **避免频繁轮换**：新信号必须比最弱持仓高出至少10分
2. **保护盈利持仓**：高分持仓（>70分）不会被轻易替换
3. **优先清理亏损**：系统倾向于清理亏损或接近止损的持仓
4. **考虑持仓时间**：避免清理刚买入的持仓（除非触发止损）

## 配置参数

在 `SmartPositionRotator` 类中可调整：

- `max_positions`: 最大持仓数（默认10）
- 评分权重：可调整各维度的分数分配
- 替换阈值：可调整需要多少分差才执行替换

## 监控和日志

系统提供详细的决策日志：

- 每个持仓的详细评分
- 新信号的评分分析
- 轮换决策原因
- 执行结果追踪

## 未来优化方向

1. **机器学习优化**：基于历史数据训练评分模型
2. **动态权重调整**：根据市场状态调整评分权重
3. **批量轮换**：支持一次替换多个弱势持仓
4. **回测验证**：对轮换决策进行历史回测

## 总结

智能持仓轮换系统解决了满仓时无法执行新信号的问题，通过科学的评分体系和智能决策逻辑，确保资金始终配置在最有潜力的标的上，提高整体投资组合的质量和收益潜力。