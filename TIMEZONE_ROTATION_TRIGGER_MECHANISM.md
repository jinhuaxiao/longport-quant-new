# 🔄 时区轮换触发机制详解

**创建时间**: 2025-11-07

---

## 📋 核心机制概述

时区轮换是 **基于时间的自动触发机制**，不需要任何外部事件或人工干预。

**触发方式**: 定时扫描 + 时间窗口检测

---

## 🔄 完整触发流程

### 1. 主循环持续运行

**位置**: `scripts/signal_generator.py:1104-1250`

```python
while True:  # 主循环
    iteration += 1
    logger.info(f"🔄 第 {iteration} 轮扫描开始")

    # ... 省略其他步骤 ...

    # 6. 🔄 收盘前自动轮换检查（每轮都执行）
    rotation_signals = []
    try:
        if account and getattr(self.settings, 'timezone_rotation_enabled', True):
            rotation_signals = await self.check_pre_close_rotation(quotes, account, regime)

            # 发送轮换信号到队列
            for rotation_signal in rotation_signals:
                success = await self.signal_queue.publish_signal(rotation_signal)
    except Exception as e:
        logger.error(f"⚠️ 收盘前轮换检查失败: {e}")

    # 等待下一轮扫描
    await asyncio.sleep(60)  # 默认 60 秒
```

**关键特点**:
- ✅ 每轮扫描都会调用 `check_pre_close_rotation()`
- ✅ 默认每 60 秒执行一次
- ✅ 不依赖外部事件，完全自动

---

### 2. 时间窗口检测

**位置**: `scripts/signal_generator.py:3241-3264`

```python
async def check_pre_close_rotation(self, quotes, account, regime):
    """收盘前自动评估并生成轮换卖出信号"""

    # 获取当前时间（北京时间）
    now = datetime.now(self.beijing_tz)

    # 判断是否在收盘前时间窗口
    should_check_hk = False
    should_check_us = False

    # 港股收盘前检查（15:30-16:00）
    if now.hour == 15 and now.minute >= 30:
        should_check_hk = True
        logger.info("🕐 港股收盘前时段：检查港股持仓轮换机会...")
    elif now.hour == 16 and now.minute == 0:
        should_check_hk = True

    # 美股收盘前检查（22:00-23:59 北京时间）
    if now.hour == 22 or now.hour == 23:
        should_check_us = True
        logger.info("🕐 美股收盘前时段：检查美股持仓轮换机会...")

    # 不在时间窗口，直接返回空列表
    if not should_check_hk and not should_check_us:
        logger.debug("  ⏭️  非收盘前时段，跳过轮换检查")
        return []

    # 在时间窗口内，继续执行轮换逻辑...
```

**时间检测逻辑**:

| 时间段 | 是否触发 | 说明 |
|--------|----------|------|
| 00:00-15:29 | ❌ | 跳过检查 |
| **15:30-16:00** | ✅ 港股 | 触发港股轮换 |
| 16:01-21:59 | ❌ | 跳过检查 |
| **22:00-23:59** | ✅ 美股 | 触发美股轮换 |

---

## 🕐 时间轴示例

### 完整一天的运行时序

```
00:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 主循环每60秒扫描一次
      ↓
      每次扫描都调用 check_pre_close_rotation()
      ↓
      但只在特定时间窗口才真正触发

15:30 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 港股收盘前 30 分钟
      ↓
      🔥 触发港股轮换检查
      ├─ 15:30:00 - 第 n 轮扫描 → ✅ 触发，检查港股持仓
      ├─ 15:31:00 - 第 n+1 轮扫描 → ✅ 触发，检查港股持仓
      ├─ 15:32:00 - 第 n+2 轮扫描 → ✅ 触发，检查港股持仓
      ├─ ... (每分钟都会触发)
      ├─ 15:59:00 - 第 n+29 轮扫描 → ✅ 触发，检查港股持仓
      └─ 16:00:00 - 第 n+30 轮扫描 → ✅ 触发，检查港股持仓

16:01 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 港股已收盘
      ↓
      每次扫描调用 check_pre_close_rotation()
      但返回空列表（时间窗口外）
      ↓
      ❌ 不触发轮换

22:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 美股收盘前 2 小时
      ↓
      🔥 触发美股轮换检查
      ├─ 22:00:00 - 第 m 轮扫描 → ✅ 触发，检查美股持仓
      ├─ 22:01:00 - 第 m+1 轮扫描 → ✅ 触发，检查美股持仓
      ├─ ... (每分钟都会触发)
      ├─ 23:59:00 - 第 m+119 轮扫描 → ✅ 触发，检查美股持仓

00:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 新的一天
      ↓
      循环继续...
```

---

## 🎯 触发频率

### 理论触发次数

| 时段 | 时长 | 扫描间隔 | 理论触发次数 |
|------|------|----------|--------------|
| 港股窗口 (15:30-16:00) | 30 分钟 | 60 秒 | **30 次** |
| 美股窗口 (22:00-23:59) | 120 分钟 | 60 秒 | **120 次** |
| 其他时段 | - | 60 秒 | 0 次（跳过） |

### 实际触发次数

**实际会更少**，因为有多重保护机制：

1. **持仓检查**: 如果没有持仓，直接返回
2. **今日已卖检查**: 如果标的今日已卖出，跳过
3. **评分阈值**: 只有评分 < 40 的弱仓位才会生成信号
4. **保护机制**: 强仓位（≥70）和新仓位（<0.5h）不触发

**实际示例**:
```
15:30:00 - ✅ 检测到 3 个弱仓位，生成 3 个卖出信号
15:31:00 - ❌ 这 3 个标的今日已有卖出订单，跳过
15:32:00 - ❌ 这 3 个标的今日已有卖出订单，跳过
...
15:59:00 - ❌ 这 3 个标的今日已有卖出订单，跳过
```

**结果**: 虽然检查了 30 次，但只在第一次生成了信号。

---

## 🛡️ 防重复机制

### 1. 今日已卖检查

**位置**: `scripts/signal_generator.py:3339-3341`

```python
# 检查是否已有卖出订单（避免重复）
if symbol in self.sold_today:
    logger.debug(f"    {symbol}: 今日已有卖出订单，跳过")
    continue
```

**作用**:
- ✅ 同一标的今日只会生成一次轮换信号
- ✅ 避免在 30 分钟窗口内重复卖出

### 2. 持仓验证

```python
# 从原始持仓获取 quantity
position = next((p for p in target_positions if p.get('symbol') == symbol), None)
if not position:
    logger.warning(f"    {symbol}: 找不到持仓信息，跳过")
    continue

quantity = position.get('quantity', 0)
if quantity <= 0:
    logger.warning(f"    {symbol}: 持仓数量无效 ({quantity})，跳过")
    continue
```

**作用**:
- ✅ 确保持仓真实存在
- ✅ 确保持仓数量有效

### 3. 评分阈值

```python
# identify_rotatable_positions() 内部
if rotation_score < self.weak_position_threshold:  # 默认 40
    # 才会标记为可轮换
```

**作用**:
- ✅ 只轮换评分 < 40 的弱仓位
- ✅ 保护强仓位（≥70）

---

## 🔍 实际运行示例

### 场景 1: 港股收盘前（有弱仓位）

```
时间: 2025-11-07 15:30:00

🔄 第 125 轮扫描开始
📊 获取到 50 个标的的实时行情
📈 市场状态: RANGE

🕐 港股收盘前时段：检查港股持仓轮换机会...
  🇭🇰 港股持仓: 5个
  🔍 分析持仓轮换评分...
    0700.HK: 评分=72 ✅ (强仓位，保护)
    1810.HK: 评分=35 ❌ (弱仓位) - 亏损15% + MACD死叉
    0388.HK: 评分=65 ✅ (一般，保留)
    2318.HK: 评分=28 ❌ (弱仓位) - 亏损20% + 跌破MA20
    0941.HK: 评分=80 ✅ (强仓位，保护)

  🎯 生成自动卖出信号（2个弱势持仓）...
    ✅ 1810.HK: 生成轮换卖出信号 (数量=100, 评分=35, 盈亏=-15.2%, 市值=$28,000)
    ✅ 2318.HK: 生成轮换卖出信号 (数量=200, 评分=28, 盈亏=-20.1%, 市值=$15,000)

  ✅ 轮换信号已发送: 1810.HK, 评分=90
  ✅ 轮换信号已发送: 2318.HK, 评分=90

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

时间: 2025-11-07 15:31:00

🔄 第 126 轮扫描开始

🕐 港股收盘前时段：检查港股持仓轮换机会...
  🇭🇰 港股持仓: 5个
  🔍 分析持仓轮换评分...
    1810.HK: 今日已有卖出订单，跳过
    2318.HK: 今日已有卖出订单，跳过
  ✅ 无弱势持仓需要轮换 (已处理)
```

### 场景 2: 非收盘前时段（跳过）

```
时间: 2025-11-07 14:30:00

🔄 第 100 轮扫描开始
📊 获取到 50 个标的的实时行情

  ⏭️  非收盘前时段，跳过轮换检查  ← 时间不在窗口内

✅ 检查止损止盈... (继续其他逻辑)
```

### 场景 3: 收盘前但无弱仓位

```
时间: 2025-11-07 22:30:00

🔄 第 200 轮扫描开始

🕐 美股收盘前时段：检查美股持仓轮换机会...
  🇺🇸 美股持仓: 3个
  🔍 分析持仓轮换评分...
    TSLA.US: 评分=75 ✅ (强仓位，保护) - 盈利12%
    AAPL.US: 评分=68 ✅ (一般，保留) - 盈利3%
    NVDA.US: 评分=82 ✅ (强仓位，保护) - 盈利25%

  ✅ 无弱势持仓需要轮换  ← 所有仓位都很强，不需要轮换
```

---

## ⚙️ 配置控制

### 开关控制

**位置**: `.env`

```bash
# 完全关闭时区轮动功能
TIMEZONE_ROTATION_ENABLED=false

# 开启时区轮动功能（默认）
TIMEZONE_ROTATION_ENABLED=true
```

**代码检查**:
```python
if account and getattr(self.settings, 'timezone_rotation_enabled', True):
    rotation_signals = await self.check_pre_close_rotation(...)
```

**效果**:
- `false`: 每轮扫描都会跳过轮换检查
- `true`: 正常执行时间窗口检测

### 参数调整

**位置**: `.env`

```bash
# 弱仓位评分阈值（默认 40）
TIMEZONE_WEAK_THRESHOLD=40

# 单次最大轮动比例（默认 30%）
TIMEZONE_MAX_ROTATION=0.30

# 强仓位保护阈值（默认 70）
TIMEZONE_STRONG_THRESHOLD=70

# 新仓位保护时间（默认 0.5 小时）
TIMEZONE_MIN_HOLDING_HOURS=0.5
```

**调整影响**:

| 参数 | 调低 | 调高 |
|------|------|------|
| WEAK_THRESHOLD | 更激进（轮动更多） | 更保守（轮动更少） |
| MAX_ROTATION | 单次轮动少 | 单次轮动多 |
| STRONG_THRESHOLD | 保护范围小 | 保护范围大 |
| MIN_HOLDING_HOURS | 更快轮动 | 更慢轮动 |

---

## 🎬 触发机制总结

### 核心原理

```
┌─────────────────────────────────────────────────────────┐
│  Signal Generator 主循环（永不停止）                      │
│                                                           │
│  while True:                                              │
│      ├─ 每 60 秒扫描一次                                  │
│      ├─ 获取账户信息                                       │
│      ├─ 获取实时行情                                       │
│      ├─ 生成买入信号                                       │
│      ├─ 检查止损止盈                                       │
│      │                                                    │
│      └─ 🔄 调用 check_pre_close_rotation()               │
│          ├─ 检查当前时间                                  │
│          ├─ 如果在 15:30-16:00 → 触发港股轮换            │
│          ├─ 如果在 22:00-23:59 → 触发美股轮换            │
│          └─ 否则 → 跳过                                   │
│                                                           │
│      await sleep(60)  ← 等待下一轮                        │
└─────────────────────────────────────────────────────────┘
```

### 触发条件（所有条件同时满足）

| 条件 | 说明 |
|------|------|
| ✅ 主循环运行 | signal_generator.py 必须在运行 |
| ✅ 配置开启 | `TIMEZONE_ROTATION_ENABLED=true` |
| ✅ 时间窗口 | 15:30-16:00 或 22:00-23:59 |
| ✅ 有账户信息 | 能获取到持仓数据 |
| ✅ 有目标持仓 | 港股窗口有港股持仓，或美股窗口有美股持仓 |
| ✅ 有弱仓位 | 至少一个持仓评分 < 40 |
| ✅ 未今日已卖 | 标的今日没有卖出记录 |

---

## 🚀 优势

### 1. 完全自动化
- ✅ 不需要人工判断和操作
- ✅ 不需要外部触发器或定时任务
- ✅ 系统自动识别和执行

### 2. 精准时间控制
- ✅ 准确在收盘前触发
- ✅ 为另一市场及时释放资金
- ✅ 最大化资金利用效率

### 3. 智能防重复
- ✅ 同一标的今日只轮换一次
- ✅ 避免过度交易
- ✅ 降低交易成本

### 4. 多重保护
- ✅ 保护强仓位（≥70分）
- ✅ 保护新仓位（<0.5小时）
- ✅ 保护高盈利仓位（>20%）

---

## 📊 与其他功能对比

| 功能 | 触发方式 | 频率 | 依赖 |
|------|----------|------|------|
| **时区轮换** | 时间窗口检测 | 每天 2 个时段 | 时间 + 持仓 |
| 买入信号 | 技术指标分析 | 每 60 秒 | 行情数据 |
| 止损止盈 | 价格触发 | 实时（WebSocket） | 行情 + 持仓 |
| 硬止损 | 亏损阈值触发 | 每 60 秒检查 | 行情 + 持仓 |

---

## 🎯 总结

**时区轮换触发机制 = 定时轮询 + 时间窗口过滤 + 智能评分 + 防重复**

1. **主动扫描**: 每 60 秒主循环都会调用轮换检查
2. **时间过滤**: 只在收盘前 30 分钟（港股）或 2 小时（美股）真正触发
3. **智能评分**: 只轮换评分 < 40 的弱仓位
4. **防重复**: 同一标的今日只生成一次轮换信号

**不需要**:
- ❌ 人工触发
- ❌ 外部定时任务（cron）
- ❌ 手动判断时机

**完全自动**:
- ✅ 系统自动检测时间
- ✅ 系统自动评估持仓
- ✅ 系统自动生成信号
- ✅ 订单执行器自动执行

---

**创建时间**: 2025-11-07
**作者**: Claude Code
**文档状态**: ✅ 完整
