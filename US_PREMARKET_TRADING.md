# 美股盘前交易支持说明

## 功能概述

本系统现已支持美股盘前时段（Pre-Market）的买入信号生成，帮助捕捉盘前的交易机会。

## 美股交易时段划分（北京时间）

| 时段 | 北京时间 | 美东时间 | 说明 |
|------|---------|---------|------|
| 🌅 盘前 | 16:00-21:30 | 04:00-09:30 | **新增支持** |
| 🌞 常规 | 21:30-次日04:00 | 09:30-16:00 | 原有支持 |
| 🌙 盘后 | 04:00-08:00 | 16:00-20:00 | 仅支持卖出 |
| 🌑 休市 | 08:00-16:00 | 20:00-次日04:00 | 不交易 |

## 配置说明

### 1. 启用盘前信号

在 `.env` 文件中配置：

```bash
# 美股盘前交易配置
ENABLE_US_PREMARKET_SIGNALS=true  # 启用盘前买入信号
US_PREMARKET_SIGNAL_WEIGHT=0.8    # 盘前信号评分权重（80%）
```

### 2. 配置项说明

| 配置项 | 默认值 | 说明 |
|--------|-------|------|
| `ENABLE_US_PREMARKET_SIGNALS` | `true` | 是否启用盘前买入信号生成 |
| `US_PREMARKET_SIGNAL_WEIGHT` | `0.8` | 盘前信号评分权重（0-1），建议0.7-0.9 |

## 风险控制机制

### 1. 评分降权

盘前信号自动降低评分，降低风险：

```
盘前信号评分 = 原始评分 × 盘前权重
例如：原始75分 × 0.8 = 60分
```

**原因**：
- 盘前流动性相对较低
- 买卖盘深度数据可能不完整
- 价格波动可能较大

### 2. 信号标记

盘前生成的信号会带有特殊标记：

```python
signal['session_type'] = 'pre_market'  # 标记为盘前信号
```

日志中使用 🌅 标识盘前信号：
```
🌅 AMZN.US: 美股盘前时段，生成盘前信号
🌅 盘前信号降权: AMZN.US 评分 75 → 60 (权重=0.8)
```

## 实施细节

### 1. 时段判断逻辑

系统通过 `_is_us_premarket()` 方法判断美股交易时段：

```python
def _is_us_premarket(self, symbol: str) -> tuple[bool, str]:
    """
    Returns:
        tuple[bool, str]: (是否盘前, 会话类型)
            会话类型: 'pre_market', 'regular', 'after_hours', 'closed'
    """
```

### 2. 信号生成流程

```
实时行情更新
    ↓
判断交易时段
    ├─ pre_market → 启用则继续，未启用则跳过
    ├─ regular → 正常处理
    ├─ after_hours → 跳过买入信号
    └─ closed → 跳过买入信号
    ↓
分析技术指标
    ↓
生成信号
    ↓
应用盘前降权（如果是盘前）
    ↓
发布到队列
```

### 3. 关键代码位置

| 功能 | 文件 | 行号 |
|------|------|------|
| 配置定义 | `.env` | 108-113 |
| 配置加载 | `src/longport_quant/config/settings.py` | 302-314 |
| 时段判断 | `scripts/signal_generator.py` | 4525-4567 |
| 信号生成逻辑 | `scripts/signal_generator.py` | 710-746 |
| 评分降权 | `scripts/signal_generator.py` | 773-782 |

## 与港股的区别

| 特性 | 港股 | 美股盘前 | 美股常规 |
|------|------|---------|---------|
| 买入信号 | ✅ 开盘时 | ✅ 盘前时段 | ✅ 常规时段 |
| 评分权重 | 100% | **80%** | 100% |
| 止损止盈 | ✅ 全天 | ✅ 全天 | ✅ 全天 |
| 收盘后处理 | ❌ 跳过买入 | N/A | N/A |
| 时段标记 | 无 | `pre_market` | `regular` |

## 预期效果

### 优势

1. **早期捕捉机会**：在盘前捕捉大新闻、财报等导致的价格变动
2. **降低风险**：通过评分降权自动控制风险
3. **灵活配置**：可通过配置随时启用/禁用
4. **清晰标识**：日志和信号中明确标记盘前交易

### 限制

1. **流动性较低**：盘前交易量通常较小
2. **无买卖盘深度**：LongPort API 盘前可能无完整买卖盘数据
3. **评分降权**：信号评分被降低，可能错过部分机会

## 监控建议

### 1. 日志监控

监控盘前信号生成：

```bash
# 查看盘前信号
tail -f logs/signal_generator_paper_001.log | grep "🌅"

# 查看盘前信号降权
tail -f logs/signal_generator_paper_001.log | grep "盘前信号降权"
```

### 2. 预期日志输出

**盘前时段（16:00-21:30）**：
```
🌅 AMZN.US: 美股盘前时段，生成盘前信号
⚡ AMZN.US: 价格变化触发实时计算 ($248.01)
📈 综合评分: 75/100
🌅 盘前信号降权: AMZN.US 评分 75 → 60 (权重=0.8)
🔔 AMZN.US: 实时信号已生成! 类型=BUY, 评分=60, 价格=$248.01
```

**非盘前时段**：
```
⏭️  AMZN.US: 美股非交易时段(closed)，跳过买入信号分析
```

## 性能影响

- **CPU 使用**：增加约 1-2%（实时行情处理）
- **内存使用**：几乎无影响
- **网络流量**：无额外API调用
- **日志量**：16:00-21:30 期间日志略有增加

## 故障排查

### 问题：盘前没有生成信号

**可能原因**：
1. 配置未启用：检查 `ENABLE_US_PREMARKET_SIGNALS=true`
2. 评分不够高：盘前降权后评分 < 30 会被过滤
3. 技术指标不满足：RSI、MACD等不符合买入条件
4. 其他预检查失败：如冷却期、持仓限制等

**排查命令**：
```bash
# 检查配置是否加载
grep "盘前" logs/signal_generator_paper_001.log | head -10

# 检查是否识别盘前时段
grep "🌅.*美股盘前时段" logs/signal_generator_paper_001.log | tail -10
```

### 问题：盘前信号评分过低

**解决方案**：
- 调高权重：将 `US_PREMARKET_SIGNAL_WEIGHT` 从 0.8 改为 0.9
- 或降低最低评分：调整买入信号的最低评分阈值

## 未来优化方向

1. **盘后买入支持**：目前仅支持盘前，未来可考虑盘后买入
2. **动态权重调整**：根据盘前流动性动态调整权重
3. **盘前专属策略**：针对盘前特点的技术指标调整
4. **盘前订单类型**：order_executor 增加盘前订单的特殊处理

## 版本历史

- **2025-11-10**: 初始实现
  - 支持美股盘前买入信号生成
  - 自动评分降权机制
  - 独立配置开关
  - 清晰的盘前标识

## 相关文档

- [港股交易时间修复](MARKET_TIME_FIX_20251110.md)
- [实时挪仓优化](REALTIME_ROTATION_OPTIMIZATION.md)
- [失败信号修复](FAILED_SIGNAL_ROTATION_FIX.md)
