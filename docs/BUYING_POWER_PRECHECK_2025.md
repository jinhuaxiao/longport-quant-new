# 购买力预检查功能 (2025)

## 问题描述

之前的订单执行流程中，系统会先尝试下单，失败后才提示"订单执行失败"。这种方式存在以下问题：

1. **错误信息不明确**：只提示"订单被拒绝或未成交"，不告知真实原因
2. **无意义的尝试**：明知资金不足还尝试下单，浪费API调用
3. **缺乏指导**：不告诉用户接下来应该怎么做

## 解决方案

### 1. 购买力预检查 (`_preflight_check_buying_power`)

在执行订单**之前**，进行以下检查：

```python
async def _preflight_check_buying_power(
    symbol: str,
    current_price: float,
    score: int,
    account: Dict
) -> tuple[bool, str, Optional[float]]:
```

**检查内容**：
- ✅ 计算最小所需资金（买1手）
- ✅ 检查账户可用现金和购买力
- ✅ 计算动态预算是否充足
- ✅ 检查是否有持仓可以换仓释放资金

**返回结果**：
- `(True, "资金充足", budget)` - 可以继续执行
- `(True, "可能可以换仓", budget)` - 资金不足但有换仓空间，系统将尝试
- `(False, "详细原因", None)` - 无法执行，直接告知原因

### 2. 改进的错误消息

**之前**：
```
❌ 订单执行失败
标的: 1211.HK
错误: 订单被拒绝或未成交
```

**现在**：
```
❌ 无法买入 1211.HK:
   • 资金不足: 需要$9,435.00, 可用$2,150.00
   • 信号评分过低(48分 < 60分)，不触发持仓轮换
   💡 建议: 等待高质量交易机会或手动释放资金
```

或者：
```
⚠️ 资金不足但可能可以换仓:
   • 标的: 3988.HK (评分65分)
   • 需要: $2,255.00, 可用: $1,200.00
   • 可能换仓: 941.HK(可释放$8,605), 386.HK(可释放$4,200)
   💡 系统将尝试智能轮换持仓...
```

### 3. 详细的通知消息

系统会发送详细的资金不足通知到Slack/Discord：

```
⚠️ 资金不足，无法执行订单

标的: 3988.HK
类型: BUY
评分: 56/100
价格: $4.50

详细说明:
❌ 无法买入 3988.HK:
   • 资金不足: 需要$2,250.00, 可用$1,200.00
   • 当前持仓无法释放足够资金
   • 持仓总数: 5个
   💡 建议: 等待高质量卖出信号或手动调整持仓

当前状态:
• 信号已延迟，等待资金释放后重试
• 系统将继续处理其他信号

建议:
• 查看是否有低质量持仓可以手动卖出
• 等待现有持仓达到止盈/止损自动释放资金
• 或等待更高质量的交易机会
```

## 智能判断逻辑

### 1. 资金充足判断

```python
has_sufficient_funds = (
    dynamic_budget >= min_required_cash and
    (available_cash >= min_required_cash or remaining_finance >= min_required_cash)
)
```

### 2. 轮换可行性判断

系统会检查：
- ✅ 信号评分是否 >= 60分（低分信号不触发轮换）
- ✅ 是否有持仓可以释放足够资金（>=80%需求）
- ✅ 持仓的市值是否足够

### 3. 分级处理

| 情况 | 评分 | 资金 | 持仓 | 处理 |
|------|------|------|------|------|
| 资金充足 | 任意 | ✅ | - | ✅ 继续执行 |
| 可换仓 | >=60 | ❌ | ✅ | ⚠️ 尝试轮换 |
| 低分信号 | <60 | ❌ | ✅ | ❌ 拒绝（不为低分卖好持仓） |
| 无持仓 | 任意 | ❌ | ❌ | ❌ 拒绝 |
| 持仓不足 | >=60 | ❌ | ⚠️ | ❌ 拒绝 |

## 技术细节

### 代码位置
- **预检查函数**: `scripts/order_executor.py:340-476`
- **调用位置**: `scripts/order_executor.py:497-509` (在 `_execute_buy_order` 开始)
- **通知函数**: `scripts/order_executor.py:2773-2817`

### 异常处理流程

```
订单执行
  ↓
购买力预检查
  ├─ 资金充足 → 继续执行
  ├─ 可能换仓 → 尝试轮换 → 继续执行
  └─ 无法执行 → 抛出 InsufficientFundsError
       ↓
    异常捕获 (主循环)
       ↓
    发送详细通知
       ↓
    延迟信号重试
```

## 效果对比

### 之前的流程
1. 尝试下单
2. 券商拒绝（资金不足）
3. 提示"订单失败"
4. 用户不知道原因和下一步

### 现在的流程
1. **预检查**资金和持仓
2. **提前告知**真实情况
3. **自动尝试**换仓（如果可行）
4. **详细通知**原因和建议
5. **智能延迟**等待资金释放

## 配置说明

无需额外配置，功能会自动启用。

### 相关参数
- `score_threshold`: 60分（低于此分数不触发轮换）
- `rotatable_threshold`: 80%（持仓需能释放>=80%的资金需求）

## 测试建议

### 场景1：资金充足
- 预期：正常执行，无额外提示

### 场景2：资金不足，高分信号，有可换仓持仓
```
输入: symbol=3988.HK, score=65, price=$4.50
账户: 现金=$1,200, 持仓=[941.HK($8,605), 386.HK($4,200)]
预期: ⚠️ 提示可能换仓，尝试智能轮换
```

### 场景3：资金不足，低分信号
```
输入: symbol=1211.HK, score=48, price=$94.35
账户: 现金=$2,150
预期: ❌ 拒绝执行，提示"低分信号不触发轮换"
```

### 场景4：资金不足，无持仓
```
输入: symbol=1398.HK, score=56, price=$6.21
账户: 现金=$500, 持仓=[]
预期: ❌ 拒绝执行，提示"无持仓可以换仓"
```

## 总结

这次改进实现了"**预判断 > 后重试**"的设计理念：

- ✅ **提前发现问题**：在下单前就知道能不能执行
- ✅ **明确告知原因**：用户知道为什么失败
- ✅ **提供可行建议**：告诉用户下一步怎么做
- ✅ **智能自动处理**：能换仓就自动尝试
- ✅ **避免无效尝试**：不浪费API调用

**核心价值**：从"单纯提示失败"到"告知真实情况和建议"，让用户明确知道系统在做什么。
