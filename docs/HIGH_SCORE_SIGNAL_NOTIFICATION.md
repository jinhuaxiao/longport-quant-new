# 高分信号延迟通知功能

## 📋 背景

**用户需求**：
```
队列中有20个延迟信号（等待207-507秒），用户不知道这些信号的存在。
即使因为资金不足暂时无法下单，高分信号也应该通知用户。
```

**问题**：
- 延迟信号中可能包含高质量交易机会（≥60分）
- 用户完全不知情，无法采取行动
- 错失手动干预的机会（手动下单、释放资金等）

## ✅ 解决方案

### 功能设计

**高分信号延迟通知**：
- 当高分信号（≥60分）因资金不足被延迟时
- 立即发送Slack通知
- 只在首次延迟（retry_count=1）时通知
- 避免重复骚扰

### 通知触发条件

| 条件 | 要求 |
|------|------|
| 信号评分 | ≥60分（高质量） |
| 延迟原因 | 资金不足 |
| 重试次数 | retry_count=1（首次延迟） |
| Slack配置 | 已启用 |

**满足所有条件时**触发通知。

### 通知内容

```
🎯 高分信号延迟处理

⚠️ 评分68分的优质信号因资金不足被延迟

📊 信号详情:
   • 标的: 883.HK
   • 评分: 68/100 (高质量信号)
   • 类型: STRONG_BUY
   • 价格: $25.50
   • 原因: RSI超买区间(72.3), MACD强势多头, 突破布林带上轨...

⏰ 延迟信息:
   • 原因: 资金不足
   • 预计重试: 1分钟后
   • 重试次数: 1/5

💰 账户状态 (HKD):
   • 现金: $159,530.52
   • 购买力: $1,813.17
   • 估算需要: $2,550.00

💡 可选操作:
   • 手动下单（如果认为机会重要）
   • 卖出部分持仓释放资金
   • 等待自动重试（共5次机会）
```

## 🔧 技术实现

### 修改文件

**文件**：`scripts/order_executor.py`

**位置**：第2637-2692行（`_requeue_remaining` 方法中）

### 代码实现

```python
# 在信号重新入队成功后
if success:
    requeued_count += 1
    logger.info(f"✅ {symbol} 已重新入队...")

    # 🔥 新增：高分信号延迟通知（只在首次延迟时通知）
    if score >= 60 and signal['retry_count'] == 1 and self.slack and reason == "资金不足":
        try:
            # 获取账户信息
            account = await self.trade_client.get_account()
            currency = "HKD" if ".HK" in symbol else "USD"
            cash = account["cash"].get(currency, 0)
            power = account.get("buy_power", {}).get(currency, 0)

            # 估算所需资金
            current_price = signal.get('price', 0)
            lot_size = 100 if ".HK" in symbol else 1
            estimated_need = current_price * lot_size

            # 获取信号原因（截取前200字符）
            reason_text = signal.get('reason', '无')
            if len(reason_text) > 200:
                reason_text = reason_text[:200] + "..."

            # 构建通知消息
            high_signal_message = (
                f"🎯 **高分信号延迟处理**\n\n"
                f"⚠️ 评分{score}分的优质信号因资金不足被延迟\n\n"
                f"📊 **信号详情:**\n"
                f"   • 标的: {symbol}\n"
                f"   • 评分: {score}/100 (高质量信号)\n"
                f"   • 类型: {signal.get('type', 'BUY')}\n"
                f"   • 价格: ${current_price:.2f}\n"
                f"   • 原因: {reason_text}\n\n"
                f"⏰ **延迟信息:**\n"
                f"   • 原因: 资金不足\n"
                f"   • 预计重试: {delay_minutes}分钟后\n"
                f"   • 重试次数: 1/{self.settings.funds_retry_max}\n\n"
                f"💰 **账户状态 ({currency}):**\n"
                f"   • 现金: ${cash:,.2f}\n"
                f"   • 购买力: ${power:,.2f}\n"
                f"   • 估算需要: ${estimated_need:,.2f}\n\n"
                f"💡 **可选操作:**\n"
                f"   • 手动下单（如果认为机会重要）\n"
                f"   • 卖出部分持仓释放资金\n"
                f"   • 等待自动重试（共{self.settings.funds_retry_max}次机会）"
            )

            # 发送通知
            await self.slack.send(high_signal_message)
            logger.info(f"📨 已发送高分信号延迟通知: {symbol} ({score}分)")

        except Exception as e:
            logger.warning(f"⚠️ 发送高分信号通知失败: {e}")
```

### 关键逻辑

**1. 触发条件检查**：
```python
if score >= 60 and signal['retry_count'] == 1 and self.slack and reason == "资金不足":
```

- `score >= 60`：只通知高分信号
- `retry_count == 1`：只在首次延迟时通知
- `self.slack`：Slack已启用
- `reason == "资金不足"`：只针对资金不足的情况

**2. 避免重复通知**：
- 使用 `retry_count == 1` 条件
- 第2次、第3次重试不再通知
- 减少对用户的打扰

**3. 信息完整性**：
- 信号详情（标的、评分、原因）
- 延迟信息（原因、重试时间）
- 账户状态（现金、购买力）
- 可选操作建议

## 📊 功能对比

### 修复前

| 场景 | 用户知道吗 | 能采取行动吗 |
|------|-----------|-------------|
| 60分信号延迟 | ❌ 否 | ❌ 否 |
| 70分信号延迟 | ❌ 否 | ❌ 否 |
| 80分信号延迟 | ❌ 否 | ❌ 否 |

**结果**：错失所有高质量机会

### 修复后

| 场景 | 用户知道吗 | 能采取行动吗 |
|------|-----------|-------------|
| 60分信号延迟 | ✅ 是（立即通知） | ✅ 是（可手动干预） |
| 70分信号延迟 | ✅ 是（立即通知） | ✅ 是（可手动干预） |
| 80分信号延迟 | ✅ 是（立即通知） | ✅ 是（可手动干预） |

**结果**：用户能及时了解并干预

## 🚀 使用场景

### 场景1：资金不足但信号优质

**情况**：
- 883.HK生成68分STRONG_BUY信号
- 但账户购买力只有$1,813
- 需要$2,550才能下单

**系统行为**：
1. 信号被延迟，设置retry_after
2. 立即发送Slack通知
3. 用户收到高分信号延迟通知

**用户选择**：
- **选项1**：认为机会重要 → 手动下单
- **选项2**：卖出其他持仓 → 释放资金 → 等待自动重试
- **选项3**：认为机会一般 → 忽略 → 让系统自动重试

### 场景2：多个高分信号同时延迟

**情况**：
- 队列中有20个延迟信号
- 其中5个评分≥60分
- 资金只够处理2个

**系统行为**：
1. 每个高分信号首次延迟时都会通知
2. 用户收到5个独立通知
3. 用户了解所有高分机会

**用户选择**：
- 从5个高分信号中选择最优的2个手动下单
- 或释放足够资金让系统自动处理

### 场景3：信号重试成功

**情况**：
- 65分信号首次延迟 → 发送通知
- 用户卖出持仓释放资金
- 1分钟后自动重试成功

**系统行为**：
1. 首次延迟：发送高分信号通知
2. 自动重试：成功下单
3. 发送成功下单通知

**用户体验**：
- 知道信号被延迟
- 采取行动释放资金
- 看到最终成功

## 📁 涉及文件

1. `scripts/order_executor.py` - 添加高分信号通知功能
2. `docs/HIGH_SCORE_SIGNAL_NOTIFICATION.md` - 功能文档（本文件）

## 🔧 配置说明

### 评分阈值

**默认**：≥60分

**修改方法**（如需调整）：
```python
# scripts/order_executor.py:2638
if score >= 60 and signal['retry_count'] == 1:  # 改为其他值
```

**建议阈值**：
- 60分：中等质量以上信号
- 65分：高质量信号
- 70分：优质信号
- 80分：极优信号

### 通知频率

**默认**：只在首次延迟时通知（retry_count=1）

**原因**：
- 避免重复打扰用户
- 一次通知已足够让用户决策
- 后续重试只是技术行为

**如需每次重试都通知**（不推荐）：
```python
# 移除 retry_count == 1 条件
if score >= 60 and self.slack and reason == "资金不足":
```

## ⚠️ 注意事项

### 1. 通知频率

**正常情况**：
- 每个高分信号只通知1次
- 不会重复骚扰

**极端情况**：
- 如果有10个高分信号同时延迟
- 会收到10个通知
- 这是正常的，因为确实有10个机会

### 2. 资金估算

**估算方法**：
```python
lot_size = 100 if ".HK" in symbol else 1
estimated_need = current_price * lot_size
```

**注意**：
- 这是简单估算，实际需求可能不同
- 仅供参考，不保证精确
- 实际下单时会重新计算

### 3. 信号原因截取

**限制**：最多显示200字符

**原因**：
- 避免通知过长
- Slack消息有长度限制
- 保持可读性

## 📊 预期效果

### 通知频率

**假设**：
- 每小时生成30个信号
- 其中10个高分信号（≥60分）
- 资金只够处理5个

**通知数量**：
- 5个高分信号延迟 → 5个通知
- 用户及时了解所有高分机会
- 可选择最优的处理

### 用户决策时间

**时间轴**：
```
14:00:00 → 信号生成（68分）
14:00:01 → 资金不足，信号延迟
14:00:02 → 发送Slack通知 ← 用户立即知道
14:00:05 → 用户看到通知
14:00:10 → 用户决定手动下单 或 释放资金
14:01:00 → 系统自动重试（如果用户未操作）
```

**决策窗口**：约1分钟

## 🎯 成功标准

- [x] 代码实现完成
- [x] 语法检查通过
- [x] 触发条件正确（≥60分，首次延迟）
- [x] 通知内容完整（信号详情+账户状态+建议）
- [x] 避免重复通知（retry_count=1）
- [x] 文档更新完成
- [ ] 实际运行测试（待服务重启后验证）
- [ ] 确认Slack通知正常发送
- [ ] 用户反馈收集

## 💡 后续优化建议

### 短期（可选）

1. **评分阈值可配置**
   ```bash
   # configs/accounts/paper_001.env
   HIGH_SCORE_NOTIFY_THRESHOLD=60  # 可调整
   ```

2. **通知分组**
   - 一次批量通知所有高分信号
   - 而不是每个信号单独通知
   - 减少通知数量

### 中期（建议）

1. **智能通知时机**
   - 工作时间立即通知
   - 非工作时间汇总通知
   - 减少非必要打扰

2. **优先级排序**
   - 在通知中按评分排序
   - 帮助用户快速识别最优机会

### 长期（架构优化）

1. **可交互通知**
   - Slack按钮：「手动下单」「忽略」
   - 用户点击按钮直接操作
   - 提升用户体验

2. **历史追踪**
   - 记录高分信号的最终结果
   - 统计成功率、收益率
   - 优化评分阈值

---

**实施日期**：2025-11-03
**实施人员**：Claude Code
**状态**：✅ 已完成编码，待重启验证
