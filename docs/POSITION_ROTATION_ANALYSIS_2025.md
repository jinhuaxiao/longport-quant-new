# 持仓分析与换仓建议 (2025)

## 功能概述

当新买入信号出现但资金不足时，系统会**自动分析当前持仓**，评估哪些持仓可以卖出腾出额度，并将详细的分析报告发送到Slack/Discord，帮助你做出换仓决策。

## 问题场景

**之前的体验**：
```
❌ 订单执行失败
标的: 3988.HK
错误: 可买数量为0
```
用户不知道：
- 为什么资金不足？
- 有没有持仓可以卖出？
- 哪些持仓应该卖出？

**现在的体验**：
```
⚠️ 资金不足，建议换仓
• 标的: 3988.HK (评分65分)
• 需要: $2,250.00, 可用: $1,200.00
• 建议卖出: 941.HK(🔴 强烈建议卖出, 释放$8,605)
• 详细分析已发送到Slack
```

同时收到Slack通知，包含完整的持仓分析报告！

## 持仓评分逻辑

系统会对每个持仓进行**轮换评分**（0-100分，越低越适合卖出）：

### 评分因素

#### 1. 盈亏影响（-50 to +30分）

| 盈亏百分比 | 评分调整 | 说明 |
|------------|----------|------|
| < -10% | -30分 | 深度亏损，优先止损 |
| -10% ~ -5% | -20分 | 中度亏损，考虑止损 |
| -5% ~ 0% | -10分 | 小幅亏损，可考虑卖出 |
| 0% ~ 5% | 0分 | 小幅盈利，中性 |
| 5% ~ 10% | +10分 | 中等盈利，建议保留 |
| 10% ~ 20% | +20分 | 高盈利，优先保留 |
| > 20% | +30分 | 超高盈利，强烈保留 |

#### 2. 持有时间影响（-10 to +10分）

| 持有时间 | 评分调整 | 说明 |
|----------|----------|------|
| < 1小时 | +10分 | 刚开仓，保留 |
| 1 ~ 24小时 | 0分 | 正常持有 |
| > 24小时 | -10分 | 持有过久，考虑清理 |

#### 3. 新信号对比（-20 to 0分）

| 新信号评分 | 评分调整 | 说明 |
|------------|----------|------|
| > 70分 | -20分 | 新信号是强信号，降低保留优先级 |
| 60~70分 | -10分 | 新信号中等，适当降低保留 |
| < 60分 | 0分 | 新信号较弱，不影响 |

### 评分示例

**示例1：深度亏损老仓位**
```
持仓: 941.HK
成本: $95.00, 现价: $86.05
盈亏: -$8.95 (-9.4%)
持有: 36小时
新信号: 65分

评分计算:
基准分: 50
盈亏: -20 (亏损5-10%)
持有时间: -10 (超过24小时)
新信号: -10 (60-70分)
-----
总分: 10/100 → 🔴 强烈建议卖出
理由: 中度亏损-9.4%, 持有过久(36.0小时)
```

**示例2：高盈利新仓位**
```
持仓: 3988.HK
成本: $4.20, 现价: $4.75
盈亏: $0.55 (+13.1%)
持有: 0.5小时
新信号: 65分

评分计算:
基准分: 50
盈亏: +20 (盈利10-20%)
持有时间: +10 (不到1小时)
新信号: -10 (60-70分)
-----
总分: 70/100 → 🟢 建议保留
理由: 高盈利+13.1%, 刚开仓
```

## Slack通知格式

当资金不足时，系统会发送详细的分析报告：

### 报告结构

```markdown
# 💰 资金不足 - 持仓分析报告

## 📈 新买入信号
• **标的:** 3988.HK
• **价格:** $4.50
• **评分:** 65/100
• **需要资金:** $2,250.00
• **可用现金:** $1,200.00
• **资金缺口:** $1,050.00

## 💼 持仓概览
• **持仓数量:** 5个
• **总市值:** $45,230.00
• **总盈亏:** -$1,256.00 (-2.78%)

## 🔴 建议换仓 (2个)

### 1. 941.HK 🔴 强烈建议卖出
• **持仓:** 100股 @ $95.00
• **现价:** $86.05
• **盈亏:** 📉 -$895.00 (-9.42%)
• **市值:** $8,605.00
• **持有:** 36.2小时
• **评分:** 10/100
• **理由:** 中度亏损-9.4%, 持有过久(36.0小时)

### 2. 386.HK 🟡 可考虑卖出
• **持仓:** 1000股 @ $4.25
• **现价:** $4.19
• **盈亏:** 📉 -$60.00 (-1.41%)
• **市值:** $4,190.00
• **持有:** 12.5小时
• **评分:** 35/100
• **理由:** 表现一般，可为更优信号腾出空间

**预计释放资金:** $12,795.00 (缺口$1,050.00)

## 🟢 建议保留 (3个)

**1. 1398.HK** 🟢 建议保留
盈亏: 📈 +12.5%, 评分: 70/100, 理由: 高盈利+12.5%

**2. 1211.HK** 🟢 建议保留
盈亏: 📈 +8.3%, 评分: 60/100, 理由: 中等盈利+8.3%

**3. 2382.HK** 🟢 建议保留
盈亏: 📈 +5.2%, 评分: 55/100, 理由: 小幅盈利+5.2%, 刚开仓

## 💡 决策建议
✅ **可以换仓:** 建议卖出上述2个持仓
• 预计释放: $12,795.00
• 足够买入: 3988.HK (需$2,250.00)
• 系统将自动尝试智能轮换

---
_自动生成于 2025-11-05 15:30:45_
```

## 换仓建议分级

### 🔴 强烈建议卖出（评分 < 30）

**触发条件**：
- 深度亏损（< -10%）
- 持有过久（> 24小时）
- 新信号强势（> 70分）

**决策建议**：优先考虑卖出，避免继续亏损

### 🟡 可考虑卖出（评分 30-50）

**触发条件**：
- 小幅亏损或盈利不佳
- 表现一般

**决策建议**：可为更优信号腾出空间

### 🟢 建议保留（评分 > 50）

**触发条件**：
- 高盈利（> 10%）
- 刚开仓（< 1小时）
- 表现良好

**决策建议**：继续持有，等待更好时机

## 技术实现

### 核心函数

#### 1. `_analyze_position_for_rotation`
```python
async def _analyze_position_for_rotation(
    position: Dict,
    new_signal_score: int
) -> Dict
```

**功能**：分析单个持仓是否适合轮换

**输入**：
- `position`: 持仓信息（symbol, quantity, cost_price, entry_time等）
- `new_signal_score`: 新信号评分

**输出**：
```python
{
    'symbol': '941.HK',
    'rotation_score': 10,  # 轮换评分
    'recommendation': '🔴 强烈建议卖出',
    'reason': '中度亏损-9.4%, 持有过久(36.0小时)',
    'pnl': -895.00,
    'pnl_pct': -9.42,
    'hold_hours': 36.2,
    'market_value': 8605.00,
    'potential_freed': 8605.00
}
```

#### 2. `_send_position_rotation_analysis`
```python
async def _send_position_rotation_analysis(
    new_signal: Dict,
    needed_amount: float,
    available_cash: float,
    all_positions: list,
    suggested_sales: list
)
```

**功能**：发送详细的持仓分析报告到Slack

**报告包含**：
- ✅ 新信号信息
- ✅ 持仓概览（数量、市值、总盈亏）
- ✅ 建议换仓列表（详细分析）
- ✅ 建议保留列表
- ✅ 决策建议

### 代码位置

- **持仓分析**: `scripts/order_executor.py:351-466`
- **预检查增强**: `scripts/order_executor.py:468-630`
- **Slack通知**: `scripts/order_executor.py:2916-3047`

## 使用流程

### 自动触发

1. **新买入信号到达**
2. **预检查发现资金不足**
3. **信号评分 >= 60分**（低分信号不触发）
4. **自动分析所有持仓**
5. **生成换仓建议**
6. **发送Slack报告**
7. **系统尝试自动轮换**（如果可行）

### 手动决策

收到Slack报告后，你可以：

1. **同意自动换仓**：系统会自动卖出建议持仓并买入新信号
2. **手动调整**：根据报告自行决定卖出哪些持仓
3. **拒绝换仓**：保持现有持仓，延迟新信号

## 配置说明

### 相关参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `score_threshold` | 60 | 触发轮换的最低信号评分 |
| `rotation_score_threshold` | 50 | 建议卖出的轮换评分阈值 |
| `max_positions_shown` | 5 | Slack报告中显示的最大持仓数 |

### 调整评分逻辑

如果你想调整评分逻辑，修改 `_analyze_position_for_rotation` 方法：

```python
# 调整盈亏权重
if pnl_pct < -10:
    rotation_score -= 30  # 改为 -40 可以更激进止损

# 调整持有时间阈值
elif hold_hours > 24:  # 改为 12 可以更快清理老仓位
    rotation_score -= 10
```

## 效果对比

### 场景：资金不足，有可换仓持仓

**之前**：
```
❌ 订单执行失败: 3988.HK
错误: 可买数量为0

（用户不知道该怎么办）
```

**现在**：
```
控制台:
⚠️ 资金不足，建议换仓
• 建议卖出: 941.HK(🔴 强烈建议卖出, 释放$8,605)
• 详细分析已发送到Slack

Slack:
# 💰 资金不足 - 持仓分析报告
[详细的持仓分析，包含：]
- 每个持仓的盈亏、持有时间
- 轮换评分和建议
- 预计释放资金
- 决策建议

（用户清楚知道哪些持仓该卖出、为什么）
```

## 最佳实践

### 1. 定期查看分析报告

即使没有新买入信号，也可以根据持仓分析报告主动调整持仓：
- 卖出深度亏损的持仓（评分 < 20）
- 止盈高盈利的持仓（> 30%）
- 清理持有过久的平庸持仓（> 3天且盈亏 < 5%）

### 2. 结合技术指标

持仓分析只考虑盈亏和时间，建议结合：
- 技术指标（RSI、MACD等）
- 市场环境（牛市/熊市）
- 个股基本面

### 3. 设置合理的换仓阈值

根据你的交易风格调整：
- **激进型**：`score_threshold=55`，更频繁换仓
- **保守型**：`score_threshold=70`，只为强信号换仓
- **平衡型**：`score_threshold=60`（默认）

## 总结

这个功能实现了**从"告知问题"到"提供解决方案"**的升级：

### ✅ 核心价值

1. **自动分析持仓**：无需手动评估每个持仓
2. **智能换仓建议**：基于多维度评分
3. **详细决策支持**：清晰的理由和数据
4. **及时Slack通知**：随时随地做决策

### 🎯 适用场景

- ✅ 资金不足但有新买入信号
- ✅ 想了解当前持仓质量
- ✅ 考虑换仓但不确定卖什么
- ✅ 需要数据支持的决策依据

### 💡 下一步

未来可以增强的功能：
- [ ] 支持手动触发持仓分析（不依赖新信号）
- [ ] 添加更多评分因素（波动率、成交量等）
- [ ] 支持批量换仓操作
- [ ] 保存历史分析报告供回顾
