# 1398.HK信号丢失问题 - 完整调查文档

## 文档清单

本目录包含关于1398.HK信号丢失问题的完整调查报告：

### 1. `investigation_summary.txt` ⭐ 必读
**用途**: 快速了解问题全貌（5分钟阅读）

**包含内容**:
- 问题规模和影响范围
- 根本原因总结
- 具体时间轴
- 代码问题位置
- 推荐修复方案
- 业务影响评估

**何时阅读**：第一次接触这个问题时

---

### 2. `investigation_1398_signal_loss.md` 📖 详细分析
**用途**: 深入理解技术细节（20分钟阅读）

**包含内容**:
- 执行摘要
- 详细的问题分析
- 系统影响分析（101个被跳过的信号）
- 两种修复方案的对比
  - 方案1: 保守方案（推荐）
  - 方案2: 完整方案（长期）
- 监控和告警建议
- 长期解决方案
- 验证清单

**何时阅读**：准备进行代码修复时

---

### 3. `problem_flow_diagram.txt` 🔄 可视化流程
**用途**: 理解问题的时间和逻辑流程（10分钟阅读）

**包含内容**:
- 完整的时间轴（13:44-13:56）
- 关键时间点和事件
- 代码问题的可视化展示
- 修复前后的对比
- 影响范围的可视化统计

**何时阅读**：想快速理解问题发生的过程时

---

## 问题快速参考

### 一句话总结
1398.HK的buy信号（得分59）在13:56:22被生成，但因为队列中有同标的的延迟重试信号，被错误的去重逻辑过滤掉了。这个问题影响了今天101个信号。

### 影响范围
- 被跳过信号: 101个
- 涉及标的: 20+个（1398.HK, 1299.HK, 3988.HK等）
- 时间范围: 11:51:26 - 14:00:40
- 所有信号评分 >= 30分（都是有效交易机会）

### 根本原因
`signal_queue.py` 的 `has_pending_signal()` 方法没有区分：
- ✓ 真正的待处理信号
- ✗ 延迟等待中的信号

导致延迟信号"占位"，阻止新信号生成。

### 代码位置
**问题文件**: `/data/web/longport-quant-new/src/longport_quant/messaging/signal_queue.py`
**问题方法**: `has_pending_signal()` (第638-672行)
**问题代码**: 没有检查 `retry_after` 字段

### 修复方案
在 `has_pending_signal()` 中添加延迟信号判断：
```python
if exclude_delayed and 'retry_after' in signal:
    if signal['retry_after'] > time.time():
        continue  # 跳过未到期的延迟信号
```

**预期修复时间**: 30-60分钟
**风险等级**: 低（只是修复去重逻辑，不改变核心流程）

---

## 时间轴速查

| 时间 | 事件 | 备注 |
|------|------|------|
| 13:44:43 | 1398.HK首次延迟（retry_after=13:47:43） | 资金不足 |
| 13:47:44 | 1398.HK再次延迟（retry_after=13:51:44） | 资金仍不足 |
| 13:51:46 | 1398.HK再次延迟（retry_after=13:56:46） | 资金仍不足 |
| **13:56:22** | **signal_generator生成新信号（得分59）** | **但被跳过！** |
| 13:56:51 | order_executor最后一次尝试 | 达到重试上限，放弃 |

---

## 相关文件速查

### 涉及的源代码文件
```
src/longport_quant/messaging/signal_queue.py
  ├─ has_pending_signal() ❌ 问题方法
  ├─ publish_signal() 
  ├─ consume_signal()
  └─ requeue_with_delay() 

scripts/signal_generator.py
  ├─ _should_generate_signal() ← 调用问题方法
  └─ _handle_realtime_update()
```

### 相关的日志文件
```
logs/signal_generator_paper_001.log
  └─ 2025-11-03 13:56:22 左右的日志显示信号被跳过

logs/order_executor_paper_001.log
  └─ 2025-11-03 13:44-13:56 的日志显示资金不足和延迟重试
```

---

## FAQ

**Q: 为什么1398.HK的信号被跳过了？**
A: 因为队列中有一个延迟重试信号也是1398.HK，而去重逻辑没有区分"延迟等待"和"真正待处理"，所以新信号被误认为需要去重。

**Q: 为什么只有1398.HK有问题？**
A: 不是的，今天有101个信号被跳过，这是系统性问题。1398.HK只是其中一个例子。

**Q: 修复会影响其他功能吗？**
A: 不会。修复只是改进去重逻辑，不改变其他流程。延迟信号仍会被正确处理。

**Q: 这个问题什么时候开始的？**
A: 今天开始（2025-11-03），首次在11:51:26出现，可能与最近的部署或配置变更有关。

**Q: 如何确保修复没有引入新问题？**
A: 有详细的验证清单在investigation_1398_signal_loss.md中。

---

## 后续行动

### 立即行动（今天）
- [ ] 阅读本文档和summary.txt
- [ ] 审查提议的修复代码
- [ ] 在测试环境中应用修复
- [ ] 验证修复的正确性

### 短期行动（本周）
- [ ] 部署到生产环境
- [ ] 监控修复效果
- [ ] 确认信号不再被错误跳过
- [ ] 调整告警阈值（如果需要）

### 中期行动（本月）
- [ ] 实施监控和告警机制
- [ ] 优化资金管理算法
- [ ] 清理延迟信号堆积

### 长期行动（后续）
- [ ] 重新设计信号状态管理
- [ ] 实现更智能的去重逻辑
- [ ] 建立信号质量评分系统

---

## 联系和支持

如有问题或需要进一步的技术支持，请查看详细分析文档或联系开发团队。

---

**文档版本**: 1.0  
**创建日期**: 2025-11-03  
**最后更新**: 2025-11-03  
**调查人**: Claude Code  
**状态**: 完成，待修复  

