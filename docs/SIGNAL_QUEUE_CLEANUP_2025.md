# 信号队列清理记录 (2025-11-05)

## 问题描述

系统出现大量订单执行失败提示，经排查发现是Redis失败队列中堆积了大量历史信号在不断重试。

## 清理前状态

### 实盘队列 (`trading:signals:failed:live_001`)
- **总数**: 54个失败信号
- **买入信号**: 42个 - 错误："可买数量为0（Fallback也失败）"
- **止损信号**: 12个
  - 10个 - 错误："订单被拒绝或未成交"
  - 2个 - 错误："TypeError: unsupported operand type(s) for -: 'NoneType' and 'float'"

### 模拟盘队列 (`trading:signals:failed:paper_001`)
- **总数**: 48个失败信号
- **买入信号**: 48个
  - 42个 - 错误："订单被拒绝或未成交"
  - 6个 - 错误："可买数量为0（Fallback也失败）"

### 影响标的
**港股**:
- 1211.HK, 3988.HK, 1398.HK, 941.HK, 386.HK
- 2382.HK, 688.HK, 1299.HK, 939.HK

**美股**:
- RDDT.US, META.US, PLTR.US, QQQ.US

## 清理执行

### 第1轮：清理"可买数量为0"的信号
```bash
模式: 可买数量为0
实盘: 移除 42个
模拟盘: 移除 6个
总计: 48个
```

**原因**：这些信号是资金不足导致的，已添加购买力预检查功能，再重试也没有意义。

### 第2轮：清理"订单被拒绝"的信号
```bash
模式: 订单被拒绝
实盘: 移除 10个
模拟盘: 移除 42个
总计: 52个
```

**原因**：这些信号可能因为市场休市、价格偏离、盘后限制等原因被拒绝，重试成功率极低。

### 第3轮：清理TypeError的信号
```bash
模式: TypeError
实盘: 移除 2个
模拟盘: 移除 0个
总计: 2个
```

**原因**：这是代码bug导致的（卖出订单计算时某个变量为None），需要修复代码后才能正常执行。

## 清理后状态

### ✅ 失败队列
- **实盘队列**: 0个（已清空）
- **模拟盘队列**: 0个（已清空）

### 📊 活跃队列
- **实盘活跃**: 2个信号处理中
- **模拟盘活跃**: 2个信号处理中

## 总结

### 清理成果
- ✅ **总计清理**: 102个堆积信号
- ✅ **实盘清理**: 54个
- ✅ **模拟盘清理**: 48个
- ✅ **队列状态**: 全部清空

### 根本原因分析

#### 1. 资金不足信号（48个）
**问题**：资金不足时，系统仍尝试下单，导致大量失败重试。

**解决方案**：
- ✅ 已实现购买力预检查功能 (`_preflight_check_buying_power`)
- ✅ 提前判断资金状况，避免无效下单
- ✅ 提供详细的资金不足原因和建议

#### 2. 订单被拒绝信号（52个）
**问题**：
- 港股收盘后仍在生成买入信号
- 市价单在盘后被拒绝
- 价格偏离过大被风控拦截

**解决方案**：
- ✅ 已实现港股收盘后停止买入信号生成
- ✅ 盘后时段强制使用限价单
- ✅ 增加TWAP策略降低价格冲击

#### 3. TypeError bug（2个）
**问题**：卖出订单执行时，某个变量为None导致计算失败。

**需要修复**：检查 `order_executor.py` 中卖出订单的成本价计算逻辑。

## 防止未来堆积的措施

### 1. 信号过期机制
建议添加信号TTL（Time To Live）：
- 买入信号：30分钟后过期
- 止损信号：永不过期（始终尝试执行）
- 止盈信号：1小时后过期

### 2. 最大重试次数
当前配置：`signal_max_retries` = 3
- 资金不足信号：建议延迟重试，等待资金释放
- 订单被拒绝信号：建议快速放弃，避免堆积

### 3. 定期清理脚本
建议添加cron任务，每小时清理：
```bash
# 清理超过1小时的失败信号
0 * * * * cd /data/web/longport-quant-new && python3 scripts/cleanup_failed_signals.py --auto --max-age 1
```

### 4. 监控告警
建议监控失败队列大小：
- 失败队列 > 20个：警告
- 失败队列 > 50个：告警
- 失败队列 > 100个：紧急

## 使用清理工具

### 手动清理
```bash
python3 scripts/cleanup_failed_signals.py
```

### 自动清理（按条件）
```bash
# 清理资金不足的信号
python3 scripts/cleanup_failed_signals.py --pattern "可买数量为0"

# 清理超过1小时的信号
python3 scripts/cleanup_failed_signals.py --old --max-age 1
```

### 分析队列（不清理）
```bash
# 只分析，不清理（选择"4. 跳过此队列"）
python3 scripts/cleanup_failed_signals.py
```

## 相关文档

- [购买力预检查功能](./BUYING_POWER_PRECHECK_2025.md)
- [港股收盘后信号控制](./MARKET_HOURS_SIGNAL_FIX_2025.md)
- [订单执行增强](./ORDER_EXECUTOR_ENHANCEMENTS_2025.md)

## 后续行动

- [ ] 修复TypeError bug（卖出订单成本价计算）
- [ ] 添加信号TTL机制
- [ ] 设置定期清理cron任务
- [ ] 添加失败队列监控告警
- [ ] 优化重试策略（区分不同错误类型）
