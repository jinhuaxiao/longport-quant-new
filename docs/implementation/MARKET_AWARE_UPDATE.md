# 市场感知功能 - 更新说明

## 🎯 新功能

高级技术指标交易系统现在支持**智能市场过滤**：

### ✨ 核心特性

**港股交易时段（9:30-16:00）**
```
📍 活跃市场: HK | 监控标的: 3个
✓ 只获取港股行情（09988.HK, 03690.HK, 01810.HK）
✓ 只检查港股持仓止损止盈
```

**美股交易时段（21:30-04:00）**
```
📍 活跃市场: US | 监控标的: 2个
✓ 只获取美股行情（AAPL.US, MSFT.US）
✓ 只检查美股持仓止损止盈
```

**非交易时段**
```
⏰ 当前时间: 不在交易时段
✓ 不获取任何行情
✓ 系统待机，每60秒检查一次
```

## 🚀 性能提升

- **减少40-60%的API调用**
- **降低网络延迟**
- **提高响应速度**
- **节省API配额**

### 每日节省对比

假设监控 3个港股 + 2个美股：

| 时段 | 之前 | 现在 | 节省 |
|------|------|------|------|
| 港股时间 (4.5h) | 270次 | 162次 | **40%** ⬇️ |
| 美股时间 (6.5h) | 390次 | 156次 | **60%** ⬇️ |
| **每日总计** | **~660次** | **~318次** | **~342次** ⬇️ |

## 📋 修改内容

### 新增方法

1. **`get_active_markets()`** - 返回当前活跃市场 `['HK']`, `['US']`, 或 `['HK', 'US']`
2. **`filter_symbols_by_market()`** - 根据市场过滤标的列表

### 修改方法

3. **`is_trading_time()`** - 现在基于 `get_active_markets()` 判断
4. **主循环** - 先过滤标的，再获取行情

### 代码量

- 新增代码: ~60行
- 修改代码: ~20行
- 文档: ~500行

## 🎬 运行示例

```bash
# 运行系统（自动识别当前市场）
python3 scripts/advanced_technical_trading.py
```

**港股时间输出：**
```
======================================================================
第 1 轮扫描 - 10:30:00
======================================================================
📍 活跃市场: HK | 监控标的: 3个
📊 获取到 3 个标的的实时行情
  ✓ 09988.HK: $175.00 (+0.92%)
  ✓ 03690.HK: $102.20 (-0.58%)
  ✓ 01810.HK: $53.65 (+0.19%)

💤 本轮扫描完成
⏳ 等待60秒进入下一轮...
```

**美股时间输出：**
```
======================================================================
第 1 轮扫描 - 22:30:00
======================================================================
📍 活跃市场: US | 监控标的: 2个
📊 获取到 2 个标的的实时行情
  ✓ AAPL.US: $254.43 (-0.40%)
  ✓ MSFT.US: $514.60 (+0.61%)

💤 本轮扫描完成
⏳ 等待60秒进入下一轮...
```

## 📚 相关文档

- **详细说明**: [docs/MARKET_AWARE_TRADING.md](docs/MARKET_AWARE_TRADING.md)
- **策略指南**: [docs/ADVANCED_STRATEGY_GUIDE.md](docs/ADVANCED_STRATEGY_GUIDE.md)
- **Slack通知**: [docs/SLACK_NOTIFICATION.md](docs/SLACK_NOTIFICATION.md)

## 🔄 兼容性

✅ **完全向后兼容** - 无需修改配置
✅ **自动启用** - 无需额外设置
✅ **透明集成** - 不影响现有功能

## ⚠️ 注意事项

1. **时区**：使用北京时间（Asia/Shanghai）
2. **假期**：暂不支持市场假期检测
3. **夏令时**：美股时间可能需要手动调整

## 🎯 适用场景

✅ 监控多市场标的（港股+美股）
✅ 长时间运行的自动交易系统
✅ API配额有限的账户
✅ 注重系统性能的用户

## 🔧 配置

无需额外配置！系统会自动：
1. 识别自选股市场（根据 `.HK` / `.US` 后缀）
2. 判断当前活跃市场
3. 过滤监控标的
4. 获取对应行情

## 📊 测试结果

```bash
# 测试市场过滤
python3 scripts/check_position_stops.py

# 检查当前持仓和止损止盈状态
# 会根据当前市场智能显示相关持仓
```

## 🎉 总结

这是一个**重要的性能优化**，让交易系统：

✅ 更智能 - 自动识别市场
✅ 更高效 - 减少API调用
✅ 更可靠 - 只用实时数据
✅ 更专业 - 符合实际交易场景

---

**版本**: v2.0 (2025-09-30)
**状态**: ✅ 已完成并测试
**影响**: 所有使用 `advanced_technical_trading.py` 的用户自动受益